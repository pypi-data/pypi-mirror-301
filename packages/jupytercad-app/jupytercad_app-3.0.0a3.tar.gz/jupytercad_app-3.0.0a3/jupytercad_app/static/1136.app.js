"use strict";(self.webpackChunk_JUPYTERLAB_CORE_OUTPUT=self.webpackChunk_JUPYTERLAB_CORE_OUTPUT||[]).push([[1136],{21136:(e,t,i)=>{i.r(t),i.d(t,{Annotation:()=>b,AnnotationModel:()=>se,Annotations:()=>B,CommandIDs:()=>s.qs,ControlPanelHeader:()=>W,ControlPanelModel:()=>q,FloatingAnnotation:()=>f,FormDialog:()=>n.R,JupyterCadMainViewPanel:()=>S,JupyterCadPanel:()=>D,JupyterCadWidget:()=>T,LeftPanelWidget:()=>U,LuminoSchemaForm:()=>G.S,MainView:()=>j,Message:()=>w,ObjectProperties:()=>z,ObjectPropertiesForm:()=>G.d,ObjectTree:()=>N.u,PanZoom:()=>Y.T,ReactAnnotations:()=>L,RightPanelWidget:()=>$,Separator:()=>te,SketcherDialog:()=>Q.O,SketcherModel:()=>Z.p,SketcherReactWidget:()=>X.p,TOOLBAR_SEPARATOR_CLASS:()=>ee,ToolbarSwitch:()=>J.Ql,ToolbarWidget:()=>ie,UsersItem:()=>K,addCommands:()=>s.uN,axesIcon:()=>v.r$,boxIcon:()=>v.bA,chamferIcon:()=>v.Qz,clippingIcon:()=>v.OZ,coneIcon:()=>v.Xg,createHeader:()=>F,cutIcon:()=>v.OL,cylinderIcon:()=>v.KP,debounce:()=>v.sg,distance:()=>J.Io,drawCircle:()=>J.hp,drawLine:()=>J.V6,drawPoint:()=>J.DE,dryRunCheck:()=>s.n9,executeOperator:()=>s.aS,explodedViewIcon:()=>v.Sz,extrusionIcon:()=>v.fd,filletIcon:()=>v.gP,focusInputField:()=>v.tn,getCSSVariableColor:()=>v.pg,getElementFromProperty:()=>v.k$,handleRemoveObject:()=>N.a,intersectionIcon:()=>v.PZ,isLightTheme:()=>v.kH,itemFromName:()=>v.vP,jcLightIcon:()=>v.Vd,logoIcon:()=>v.Xo,minimizeIcon:()=>v.MR,nearest:()=>v.pA,newName:()=>s.oW,removeStyleFromProperty:()=>v.TG,requestAPI:()=>v.qZ,setVisible:()=>s.Li,sphereIcon:()=>v.bh,throttle:()=>v.nF,torusIcon:()=>v.pv,unionIcon:()=>v.N0,wireframeIcon:()=>v.Mx});var s=i(4256),n=i(51042),o=i(47079),a=i(80281),r=i(8996),l=i(95870),d=i(94939),c=i(31218),h=i(94022),m=i(42392),p=i(33760),u=i(68478),_=i(18504),g=i(64530),v=i(74998);const w=e=>{var t,i,s;const{self:n,message:o,user:a}=e,r=null!==(t=null==a?void 0:a.color)&&void 0!==t?t:"black",d=null!==(i=null==a?void 0:a.display_name)&&void 0!==i?i:"",c=null!==(s=null==a?void 0:a.initials)&&void 0!==s?s:"";return l.createElement("div",{className:"jcad-Annotation-Message",style:{flexFlow:n?"row":"row-reverse"}},l.createElement("div",{className:"jcad-Annotation-User-Icon",style:{backgroundColor:r},title:d},l.createElement("span",{style:{width:24,textAlign:"center"}},c)),l.createElement("div",{className:"jcad-Annotation-Message-Content"},l.createElement("p",{style:{padding:7,margin:0}},o)))},b=e=>{const{itemId:t,model:i}=e,s=i.getAnnotation(t),n=l.useMemo((()=>{var e;return null!==(e=null==s?void 0:s.contents)&&void 0!==e?e:[]}),[s]),[o,a]=l.useState("");if(!s)return l.createElement("div",null);const r=()=>{i.addContent(t,o),a("")};return l.createElement("div",{className:"jcad-Annotation"},e.children,l.createElement("div",{style:{paddingBottom:10,maxHeight:400,overflow:"auto"}},n.map((e=>{var t,s;return l.createElement(w,{user:e.user,message:e.value,self:(null===(t=i.user)||void 0===t?void 0:t.username)===(null===(s=e.user)||void 0===s?void 0:s.username)})}))),l.createElement("div",{className:"jcad-Annotation-Message"},l.createElement("textarea",{rows:3,placeholder:"Ctrl+Enter to submit",value:o,onChange:e=>a(e.currentTarget.value),onKeyDown:e=>{e.ctrlKey&&"Enter"===e.key&&r()}}),l.createElement("div",{onClick:r},l.createElement(g.caretRightIcon.react,{className:"jcad-Annotation-Submit"}))))},f=e=>{const{itemId:t,model:i}=e,[s,n]=l.useState(e.open),o=e=>{var s;return e?n(!0):(null===(s=i.getAnnotation(t))||void 0===s?void 0:s.contents.length)?void n(!1):i.removeAnnotation(t)};return l.createElement("div",null,l.createElement("div",{className:"jcad-Annotation-Handler",onClick:()=>o(!s)}),l.createElement("div",{className:"jcad-FloatingAnnotation",style:{visibility:s?"visible":"hidden"}},l.createElement(b,{model:i,itemId:t},l.createElement("div",{className:"jcad-Annotation-Topbar"},l.createElement("div",{onClick:async()=>{var e;if(!(null===(e=i.getAnnotation(t))||void 0===e?void 0:e.contents.length))return i.removeAnnotation(t);(await(0,_.showDialog)({title:"Delete Annotation",body:"Are you sure you want to delete this annotation?",buttons:[_.Dialog.cancelButton(),_.Dialog.okButton({label:"Delete"})]})).button.accept&&i.removeAnnotation(t)}},l.createElement(g.closeIcon.react,{className:"jcad-Annotation-TopBarIcon"})),l.createElement("div",{onClick:()=>{o(!1)}},l.createElement(v.MR.react,{className:"jcad-Annotation-TopBarIcon"}))))))};function y(e){var t;return(null===(t=e.remoteUser)||void 0===t?void 0:t.display_name)?l.createElement("div",{style:{position:"absolute",top:1,right:3,background:e.remoteUser.color}},`Following ${e.remoteUser.display_name}`):null}var C=i(62572);function M(e){return l.createElement("div",{className:"jpcad-Spinner",style:{display:e.loading?"flex":"none"}},l.createElement("div",{className:"jpcad-SpinnerContent"}))}class j extends l.Component{constructor(e){super(e),this.addContextMenu=()=>{const e=new o.CommandRegistry;e.addCommand("add-annotation",{execute:()=>{if(!this._pointer3D)return;const e=(new d.Pq0).copy(this._pointer3D.mesh.position);if(this._explodedView.enabled){const t=(0,C.US)({mesh:this._pointer3D.mesh,boundingGroup:this._boundingGroup,factor:this._explodedView.factor});e.add(t.vector.multiplyScalar(-t.distance))}this._mainViewModel.addAnnotation({position:[e.x,e.y,e.z],label:"New annotation",contents:[],parent:this._pointer3D.parent.name})},label:"Add annotation",isEnabled:()=>!!this._pointer3D}),this._contextMenu=new a.ContextMenu({commands:e}),this._contextMenu.addItem({command:"add-annotation",selector:"canvas",rank:1})},this.sceneSetup=()=>{if(null!==this.divRef.current){C.YQ.set((0,v.pg)(C.qX)),C.so.set((0,v.pg)(C.OP)),C.A1.set((0,v.pg)(C.In)),this._camera=new d.ubm(50,2,.1,1e3),this._camera.position.set(8,8,8),this._camera.up.set(0,0,1),this._scene=new d.Z58,this._scene.add(new d.$p8(16777215,.5)),this._cameraLight=new d.HiM(16777215,1),this._camera.add(this._cameraLight),this._scene.add(this._camera),this._renderer=new d.JeP({alpha:!0,antialias:!0,stencil:!0}),this._clock=new d.zD7,this._renderer.autoClear=!1,this._renderer.setClearColor(0,0),this._renderer.setSize(500,500,!1),this.divRef.current.appendChild(this._renderer.domElement),this._syncPointer=(0,v.nF)(((e,t)=>{e&&t?this._model.syncPointer({parent:t,x:e.x,y:e.y,z:e.z}):this._model.syncPointer(void 0)}),100),this._renderer.domElement.addEventListener("pointermove",this._onPointerMove.bind(this)),this._renderer.domElement.addEventListener("mouseup",(e=>{this._onClick.bind(this)(e)})),this._renderer.domElement.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation(),this._contextMenu.open(e)})),document.addEventListener("keydown",(e=>{this._onKeyDown.bind(this)(e)}));const e=new c.N(this._camera,this._renderer.domElement);e.target.set(this._scene.position.x,this._scene.position.y,this._scene.position.z),this._controls=e,e.enableDamping=!0,e.dampingFactor=.15,this._controls.addEventListener("change",(()=>{this._updateAnnotation()})),this._controls.addEventListener("change",(0,v.nF)((()=>{var e;(null===(e=this._model.localState)||void 0===e?void 0:e.remoteUser)||this._model.syncCamera({position:this._camera.position.toArray([]),rotation:[this._camera.rotation.x,this._camera.rotation.y,this._camera.rotation.z],up:this._camera.up.toArray([])},this._mainViewModel.id)}),100)),this._transformControls=new h.ZU(this._camera,this._renderer.domElement),this._clippingPlaneMeshControl=new d.eaF(new d.bdM(1,1),new d.V9B({color:"black",opacity:.2,transparent:!0,side:d.$EB})),this._clippingPlaneMeshControl.visible=!1;const t=new d.Pq0(0,0,1);this._clippingPlane.coplanarPoint(t),this._clippingPlaneMeshControl.geometry.translate(t.x,t.y,t.z),this._clippingPlaneMeshControl.quaternion.setFromUnitVectors(new d.Pq0(0,0,1),this._clippingPlane.normal),this._scene.add(this._clippingPlaneMeshControl),this._transformControls.addEventListener("dragging-changed",(e=>{this._controls.enabled=!e.value})),this._transformControls.addEventListener("change",(()=>{const e=new d.Pq0(0,0,1);this._clippingPlane.setFromNormalAndCoplanarPoint(e.applyEuler(this._clippingPlaneMeshControl.rotation),this._clippingPlaneMeshControl.position)})),this._transformControls.attach(this._clippingPlaneMeshControl),this._scene.add(this._transformControls),this._transformControls.enabled=!1,this._transformControls.visible=!1,this._viewHelper=new u.s(this._camera,this._renderer.domElement),this._viewHelper.center=this._controls.target;const i=document.createElement("div");i.id="viewHelper",i.style.position="absolute",i.style.right="0px",i.style.bottom="0px",i.style.height="128px",i.style.width="128px",this.divRef.current.appendChild(i),i.addEventListener("pointerup",(e=>this._viewHelper.handleClick(e)))}},this.animate=()=>{this._requestID=window.requestAnimationFrame(this.animate);const e=this._clock.getDelta();for(const e of this._edgeMaterials)e.resolution.set(this._renderer.domElement.width,this._renderer.domElement.height);null!==this._clippingPlaneMesh&&(this._clippingPlane.coplanarPoint(this._clippingPlaneMesh.position),this._clippingPlaneMesh.lookAt(this._clippingPlaneMesh.position.x-this._clippingPlane.normal.x,this._clippingPlaneMesh.position.y-this._clippingPlane.normal.y,this._clippingPlaneMesh.position.z-this._clippingPlane.normal.z)),this._viewHelper.animating&&this._viewHelper.update(e),this._controls.update(),this._renderer.setRenderTarget(null),this._renderer.clear(),this._renderer.render(this._scene,this._camera),this._viewHelper.render(this._renderer)},this.resizeCanvasToDisplaySize=()=>{null!==this.divRef.current&&(this._renderer.setSize(this.divRef.current.clientWidth,this.divRef.current.clientHeight,!1),this._camera instanceof d.ubm?this._camera.aspect=this.divRef.current.clientWidth/this.divRef.current.clientHeight:this._camera instanceof d.qUd&&(this._camera.left=this.divRef.current.clientWidth/-2,this._camera.right=this.divRef.current.clientWidth/2,this._camera.top=this.divRef.current.clientHeight/2,this._camera.bottom=this.divRef.current.clientHeight/-2),this._camera.updateProjectionMatrix())},this.generateScene=()=>{this.sceneSetup(),this.animate(),this.resizeCanvasToDisplaySize()},this._shapeToMesh=e=>{null!==this._meshGroup&&this._scene.remove(this._meshGroup),null!==this._explodedViewLinesHelperGroup&&this._scene.remove(this._explodedViewLinesHelperGroup),null!==this._clippingPlaneMesh&&this._scene.remove(this._clippingPlaneMesh);const t=this._selectedMeshes.map((e=>e.name));this._selectedMeshes=[],this._boundingGroup=new d.NRn,this._edgeMaterials=[],this._meshGroup=new d.YJl,Object.entries(e).forEach((([e,i])=>{var s,n,o,a;const r=t.includes(e),l=this._model.sharedModel.getObjectByName(e),c=null===(s=null==l?void 0:l.parameters)||void 0===s?void 0:s.Color,h=!("Part::Extrusion"===(null==l?void 0:l.shape)&&!(null===(n=null==l?void 0:l.parameters)||void 0===n?void 0:n.Solid)),m=(0,C.is)({objName:e,data:i,clippingPlanes:this._clippingPlanes,selected:r,isSolid:h,objColor:c});if(m){const{meshGroup:e,mainMesh:i,edgesMeshes:s}=m;if(e.visible&&this._boundingGroup.expandByObject(i),null===(o=i.material)||void 0===o?void 0:o.color){const e=new d.Q1f(c||C.YQ);r||(i.material.color=e),i.userData.originalColor=e.clone()}r&&this._selectedMeshes.push(i),s.forEach((e=>{var i;this._edgeMaterials.push(e.material);const s=new d.Q1f(c),n=.2126*s.r+.7152*s.g+.0722*s.b;let o;if(n>=0&&n<=.05)o=new d.Q1f(.2,.2,.2);else if(n<.1){const e=3+3*(.1-n);o=s.clone().multiplyScalar(e)}else if(n<.5){const e=1.3+1.3*(.5-n);o=s.clone().multiplyScalar(e)}else{const e=.7-.3*(n-.5);o=s.clone().multiplyScalar(e)}t.includes(e.name)?(this._selectedMeshes.push(e),e.material.color=C.A1,e.material.linewidth=C.Tx,e.userData.originalColor=o.clone()):c&&(null===(i=e.material)||void 0===i?void 0:i.color)&&(e.material.color=o,e.userData.originalColor=o.clone())})),null===(a=this._meshGroup)||void 0===a||a.add(e)}})),this._updateRefLength(),this._setupExplodedView();const i=new d.bdM(10*this._refLength,10*this._refLength),s=new d.tXL({color:C.so,stencilWrite:!0,stencilRef:0,stencilFunc:d.klZ,stencilFail:d.kG0,stencilZFail:d.kG0,stencilZPass:d.kG0,side:d.$EB,wireframe:this.state.wireframe});this._clippingPlaneMesh=new d.eaF(i,s),this._clippingPlaneMesh.visible=this._clipSettings.enabled,this._clippingPlaneMesh.onAfterRender=e=>{e.clearStencil()},this._scene.add(this._clippingPlaneMesh),this._scene.add(this._meshGroup),this._loadingTimeout&&(clearTimeout(this._loadingTimeout),this._loadingTimeout=null),this.setState((e=>Object.assign(Object.assign({},e),{loading:!1})))},this._onSharedMetadataChanged=(e,t)=>{const i=Object.assign({},this.state.annotations);t.forEach(((e,t)=>{if(!t.startsWith("annotation"))return;const s=this._model.sharedModel.getMetadata(t);let n=!0;if(this.state.firstLoad&&(n=!1),!s||"add"!==e.action&&"update"!==e.action)"delete"===e.action&&delete i[t];else{const e=JSON.parse(s);e.open=n,i[t]=e}})),this.setState((e=>Object.assign(Object.assign({},e),{annotations:i,firstLoad:!1})))},this._onClientSharedStateChanged=(e,t)=>{var i,s,n,o,a,r,l;const c=null===(i=this._model.localState)||void 0===i?void 0:i.remoteUser;if(c){const e=t.get(c);if(!e)return;(null===(s=e.user)||void 0===s?void 0:s.username)!==(null===(n=this.state.remoteUser)||void 0===n?void 0:n.username)&&this.setState((t=>Object.assign(Object.assign({},t),{remoteUser:e.user}))),(null===(o=e.selected)||void 0===o?void 0:o.value)&&this._updateSelected(e.selected.value);const i=e.camera;if(null==i?void 0:i.value){const{position:e,rotation:t,up:s}=i.value;this._camera.position.set(e[0],e[1],e[2]),this._camera.rotation.set(t[0],t[1],t[2]),this._camera.up.set(s[0],s[1],s[2])}}else{if(null!==this.state.remoteUser){this.setState((e=>Object.assign(Object.assign({},e),{remoteUser:null})));const e=null===(r=null===(a=this._model.localState)||void 0===a?void 0:a.camera)||void 0===r?void 0:r.value;if(e){const t=e.position,i=e.rotation,s=e.up;this._camera.position.set(t[0],t[1],t[2]),this._camera.rotation.set(i[0],i[1],i[2]),this._camera.up.set(s[0],s[1],s[2])}}const e=this._model.localState;(null===(l=null==e?void 0:e.selected)||void 0===l?void 0:l.value)&&this._updateSelected(e.selected.value)}t.forEach(((e,t)=>{var i,s;const n=null===(i=e.pointer)||void 0===i?void 0:i.value;if(this._model.getClientId()===t)return;let o=this._collaboratorPointers[t];if(n){const i=null===(s=this._meshGroup)||void 0===s?void 0:s.getObjectByName(n.parent);if(!o){const s=this._createPointer(e.user);o=this._collaboratorPointers[t]={mesh:s,parent:i},this._scene.add(s)}if(o.mesh.visible=!0,this._explodedView.enabled){const e=(0,C.US)({mesh:i,boundingGroup:this._boundingGroup,factor:this._explodedView.factor}),t=e.vector.multiplyScalar(e.distance);o.mesh.position.copy(new d.Pq0(n.x+t.x,n.y+t.y,n.z+t.z))}else o.mesh.position.copy(new d.Pq0(n.x,n.y,n.z));o.parent=i}else this._collaboratorPointers[t]&&(this._collaboratorPointers[t].mesh.visible=!1)}))},this._handleThemeChange=()=>{const e=(0,v.kH)();C.YQ.set((0,v.pg)(C.qX)),C.so.set((0,v.pg)(C.OP)),C.A1.set((0,v.pg)(C.In)),this.setState((t=>Object.assign(Object.assign({},t),{lightTheme:e})))},this._handleWindowResize=()=>{this.resizeCanvasToDisplaySize(),this._updateAnnotation()},this.divRef=l.createRef(),this._selectedMeshes=[],this._meshGroup=null,this._boundingGroup=new d.NRn,this._explodedView={enabled:!1,factor:0},this._explodedViewLinesHelperGroup=null,this._cameraSettings={type:"Perspective"},this._clipSettings={enabled:!1,showClipPlane:!0},this._clippingPlaneMesh=null,this._clippingPlane=new d.Zcv(new d.Pq0(-1,0,0),0),this._clippingPlanes=[this._clippingPlane],this._edgeMaterials=[],this._raycaster=new d.tBo,this._requestID=null,this._refLength=null,this._pointer3D=null,this._geometry=new d.LoY,this._geometry.setDrawRange(0,3e4),this._mainViewModel=this.props.viewModel,this._mainViewModel.viewSettingChanged.connect(this._onViewChanged,this),this._model=this._mainViewModel.jcadModel,this._pointer=new d.I9Y,this._collaboratorPointers={},this._model.themeChanged.connect(this._handleThemeChange,this),this._mainViewModel.jcadModel.sharedOptionsChanged.connect(this._onSharedOptionsChanged,this),this._mainViewModel.jcadModel.clientStateChanged.connect(this._onClientSharedStateChanged,this),this._mainViewModel.jcadModel.sharedMetadataChanged.connect(this._onSharedMetadataChanged,this),this._mainViewModel.renderSignal.connect(this._requestRender,this),this._mainViewModel.workerBusy.connect(this._workerBusyHandler,this),this._raycaster.params.Line={threshold:50},this.state={id:this._mainViewModel.id,lightTheme:(0,v.kH)(),loading:!0,annotations:{},firstLoad:!0,wireframe:!1}}componentDidMount(){window.addEventListener("resize",this._handleWindowResize),this.generateScene(),this.addContextMenu(),this._mainViewModel.initWorker(),this._mainViewModel.initSignal()}componentDidUpdate(e,t){this.resizeCanvasToDisplaySize()}componentWillUnmount(){window.cancelAnimationFrame(this._requestID),window.removeEventListener("resize",this._handleWindowResize),this._mainViewModel.viewSettingChanged.disconnect(this._onViewChanged,this),this._controls.dispose(),this._model.themeChanged.disconnect(this._handleThemeChange,this),this._model.sharedOptionsChanged.disconnect(this._onSharedOptionsChanged,this),this._mainViewModel.jcadModel.clientStateChanged.disconnect(this._onClientSharedStateChanged,this),this._mainViewModel.jcadModel.sharedMetadataChanged.disconnect(this._onSharedMetadataChanged,this),this._mainViewModel.renderSignal.disconnect(this._requestRender,this),this._mainViewModel.workerBusy.disconnect(this._workerBusyHandler,this),this._mainViewModel.dispose()}_updateAnnotation(){Object.keys(this.state.annotations).forEach((e=>{var t;const i=document.getElementById(e);if(i){const s=null===(t=this._model.annotationModel)||void 0===t?void 0:t.getAnnotation(e);let n=new d.I9Y;s&&(n=this._computeAnnotationPosition(s)),i.style.left=`${Math.round(n.x)}px`,i.style.top=`${Math.round(n.y)}px`}}))}_onPointerMove(e){const t=this._renderer.domElement.getBoundingClientRect();this._pointer.x=(e.clientX-t.left)/t.width*2-1,this._pointer.y=-(e.clientY-t.top)/t.height*2+1;const i=this._pick();if(!this._pointer3D&&this._model.localState&&i&&(this._pointer3D={parent:i.mesh,mesh:this._createPointer(this._model.localState.user)},this._scene.add(this._pointer3D.mesh)),i){if(!this._pointer3D)return void this._syncPointer(void 0,void 0);if(this._pointer3D.mesh.visible=!0,this._pointer3D.mesh.position.copy(i.position),this._pointer3D.parent=i.mesh,this._explodedView.enabled){const e=(0,C.US)({mesh:this._pointer3D.parent,boundingGroup:this._boundingGroup,factor:this._explodedView.factor});i.position.add(e.vector.multiplyScalar(-e.distance))}this._syncPointer(i.position,i.mesh.name)}else this._pointer3D&&(this._pointer3D.mesh.visible=!1),this._syncPointer(void 0,void 0)}_pick(){var e,t;if(null===this._meshGroup||!this._meshGroup.children)return null;this._raycaster.setFromCamera(this._pointer,this._camera);const i=this._raycaster.intersectObjects(this._meshGroup.children);if(i.length>0)for(const s of i){if(!s.object.visible||!(null===(e=s.object.parent)||void 0===e?void 0:e.visible))continue;const i=new d.Pq0;if(this._clippingPlane.coplanarPoint(i),i.sub(s.point),!(this._clipSettings.enabled&&i.dot(this._clippingPlane.normal)>0))return{mesh:s.object.name.includes("-front")?s.object.parent.getObjectByName(s.object.name.replace("-front","")):s.object,position:null!==(t=s.pointOnLine)&&void 0!==t?t:s.point}}return null}_onClick(e){var t,i;const s=this._pick(),n=new Set(this._selectedMeshes.map((e=>e.name)));if(s){const o=s.mesh.name;if(e.ctrlKey)n.has(o)?n.delete(o):n.add(o);else{const e=n.has(o);n.clear(),e||n.add(o)}const a=Array.from(n),r={};for(const e of a)r[e]=null===(i=null===(t=this._meshGroup)||void 0===t?void 0:t.getObjectByName(e))||void 0===i?void 0:i.userData;this._updateSelected(r),this._model.syncSelected(r,this._mainViewModel.id)}}_onKeyDown(e){this._clipSettings.enabled&&"r"===e.key&&(e.preventDefault(),e.stopPropagation(),"rotate"===this._transformControls.mode?this._transformControls.setMode("translate"):this._transformControls.setMode("rotate"))}_updateRefLength(e=!1){if(this._meshGroup){if(e||null===this._refLength&&this._meshGroup.children.length){const e=new d.Pq0;this._boundingGroup.getSize(e),this._refLength=Math.max(e.x,e.y,e.z)/5||1,this._updatePointers(this._refLength),this._camera.lookAt(this._scene.position),this._camera.position.set(10*this._refLength,10*this._refLength,10*this._refLength),this._camera.far=200*this._refLength,this._clippingPlaneMeshControl.geometry=new d.bdM(10*this._refLength,10*this._refLength)}this._meshGroup.children.length||(this._refLength=null)}}async _objToMesh(e,t){var i;const{binary:s,format:n,value:o}=t;let a;if("STL"===n){let e;if(s){const t=`data:application/octet-stream;base64,${o}`,i=await fetch(t);e=await i.arrayBuffer()}else e=o;a=(new p.t).parse(e)}if(!a)return;const r=new d.tXL({color:C.YQ,wireframe:this.state.wireframe}),l=new d.eaF(a,r),c=new d.XJ7(l.geometry),h=new d.mrM({color:"black"}),m=new d.DXC(c,h);l.add(m),l.name=e,l.visible=!0,this._meshGroup&&(this._meshGroup.add(l),null===(i=this._boundingGroup)||void 0===i||i.expandByObject(l)),this._updateRefLength(!0)}_workerBusyHandler(e,t){this._loadingTimeout&&clearTimeout(this._loadingTimeout),t?this._loadingTimeout=setTimeout((()=>{this.setState((e=>Object.assign(Object.assign({},e),{loading:!0})))}),250):this.setState((e=>Object.assign(Object.assign({},e),{loading:!1})))}async _requestRender(e,t){const{shapes:i,postShapes:s,postResult:n}=t;if(null!=i){this._shapeToMesh(i);const e={binary:!0,onlyVisible:!1};if(n&&this._meshGroup){const t=new m.r,i=[];Object.values(n).forEach((s=>{var n;const o=null===(n=s.jcObject.parameters)||void 0===n?void 0:n.Object;if(!o)return;const a=this._meshGroup.getObjectByName(`${o}-group`);if(!a)return;const r=new Promise((i=>{t.parse(a,(e=>{s.postShape=e,i()}),(()=>{}),e)}));i.push(r)})),await Promise.all(i),this._mainViewModel.sendRawGeometryToWorker(n)}}null!=s&&Object.entries(s).forEach((([e,t])=>{this._objToMesh(e,t)}))}_updatePointers(e){this._pointerGeometry=new d.Gu$(e/10,32,32);for(const e in this._collaboratorPointers)this._collaboratorPointers[e].mesh.geometry=this._pointerGeometry}_createPointer(e){var t,i;let s=null;s=(null===(t=null==e?void 0:e.color)||void 0===t?void 0:t.startsWith("var"))?r.Ay(getComputedStyle(document.documentElement).getPropertyValue(e.color.slice(4,-1))):r.Ay(null!==(i=null==e?void 0:e.color)&&void 0!==i?i:"steelblue");const n=new d.V9B({color:s?new d.Q1f(s.r/255,s.g/255,s.b/255):"black"});return new d.eaF(this._pointerGeometry,n)}_updateSelected(e){var t,i,s;for(const e of this._selectedMeshes){let i=e.userData.originalColor;i||(i=e.material.color.clone(),e.userData.originalColor=i),(null===(t=e.material)||void 0===t?void 0:t.color)&&(e.material.color=i);const s=e.material;(null==s?void 0:s.linewidth)&&(s.linewidth=C.t5)}this._selectedMeshes=[];for(const t in e){const e=null===(i=this._meshGroup)||void 0===i?void 0:i.getObjectByName(t);if(!e)continue;e.userData.originalColor||(e.userData.originalColor=e.material.color.clone()),this._selectedMeshes.push(e),(null===(s=null==e?void 0:e.material)||void 0===s?void 0:s.color)&&(e.material.color=C.A1);const n=e.material;(null==n?void 0:n.linewidth)&&(n.linewidth=C.Tx)}}_onSharedOptionsChanged(e,t){var i,s;const n=e.objects;if(n)for(const e of n){const t=e.name,n=null===(i=this._meshGroup)||void 0===i?void 0:i.getObjectByName(t);if(!n)continue;const o=e.visible,a=null==n?void 0:n.material.color;n.parent.visible=o;const r=null===(s=this._explodedViewLinesHelperGroup)||void 0===s?void 0:s.getObjectByName(t);if(r&&(r.visible=o),n.material.color)if("color"in e){const t=e.color,i=new d.Q1f(t[0],t[1],t[2]);n.material.color=i}else n.material.color=a||C.YQ}}_onViewChanged(e,t){var i;if("axes"===t.key){null===(i=this._sceneAxe)||void 0===i||i.removeFromParent();const e=t.newValue;"remove"!==t.type&&e&&e.visible&&(this._sceneAxe=new d.IzY(e.size),this._scene.add(this._sceneAxe))}if("explodedView"===t.key){const e=t.newValue;"remove"!==t.type&&e&&(this._explodedView=e,this._setupExplodedView())}if("cameraSettings"===t.key){const e=t.newValue;"remove"!==t.type&&e&&(this._cameraSettings=e,this._updateCamera())}if("clipView"===t.key){const e=t.newValue;"remove"!==t.type&&e&&(this._clipSettings=e,this._updateClipping())}if("wireframe"===t.key){const e=t.newValue;void 0!==e&&this.setState((t=>Object.assign(Object.assign({},t),{wireframe:e})),(()=>{this._meshGroup&&(this._meshGroup.traverse((t=>{t instanceof d.eaF&&(t.material.wireframe=e,t.material.needsUpdate=!0)})),this._renderer.render(this._scene,this._camera))}))}}_setupExplodedView(){var e,t,i,s;if(this._explodedView.enabled){const i=new d.Pq0;this._boundingGroup.getCenter(i),null===(e=this._explodedViewLinesHelperGroup)||void 0===e||e.removeFromParent(),this._explodedViewLinesHelperGroup=new d.YJl;for(const e of null===(t=this._meshGroup)||void 0===t?void 0:t.children){const t=(0,C.US)({mesh:e.getObjectByName(e.name.replace("-group","")),boundingGroup:this._boundingGroup,factor:this._explodedView.factor});e.position.set(0,0,0),e.translateOnAxis(t.vector,t.distance);const i=new d.mrM({color:C.so,linewidth:C.t5}),s=(new d.LoY).setFromPoints([t.oldGeometryCenter,t.newGeometryCenter]),n=new d.N1A(s,i);n.name=e.name,n.visible=e.visible,this._explodedViewLinesHelperGroup.add(n)}this._scene.add(this._explodedViewLinesHelperGroup)}else{for(const e of null===(i=this._meshGroup)||void 0===i?void 0:i.children)e.position.set(0,0,0);null===(s=this._explodedViewLinesHelperGroup)||void 0===s||s.removeFromParent()}}_updateCamera(){var e,t;const i=(new d.Pq0).copy(this._camera.position),s=(new d.Pq0).copy(this._camera.up);if(this._camera.remove(this._cameraLight),this._scene.remove(this._camera),"Perspective"===this._cameraSettings.type)this._camera=new d.ubm(50,2,.1,1e3);else{const i=(null===(e=this.divRef.current)||void 0===e?void 0:e.clientWidth)||0,s=(null===(t=this.divRef.current)||void 0===t?void 0:t.clientHeight)||0;this._camera=new d.qUd(i/-2,i/2,s/2,s/-2)}this._camera.add(this._cameraLight),this._scene.add(this._camera),this._controls.object=this._camera,this._camera.position.copy(i),this._camera.up.copy(s)}_updateClipping(){this._clipSettings.enabled?(this._renderer.localClippingEnabled=!0,this._transformControls.enabled=!0,this._transformControls.visible=!0,this._clippingPlaneMeshControl.visible=this._clipSettings.showClipPlane,this._clippingPlaneMesh&&(this._clippingPlaneMesh.visible=!0)):(this._renderer.localClippingEnabled=!1,this._transformControls.enabled=!1,this._transformControls.visible=!1,this._clippingPlaneMeshControl.visible=!1,this._clippingPlaneMesh&&(this._clippingPlaneMesh.visible=!1))}_computeAnnotationPosition(e){var t;const i=null===(t=this._meshGroup)||void 0===t?void 0:t.getObjectByName(e.parent),s=new d.Pq0(e.position[0],e.position[1],e.position[2]);if(this._explodedView.enabled&&i){const e=(0,C.US)({mesh:i,boundingGroup:this._boundingGroup,factor:this._explodedView.factor}),t=e.vector.multiplyScalar(e.distance);s.add(t)}const n=this._renderer.domElement;return(0,C.jb)({vector:s,camera:this._camera,width:n.width,height:n.height})}render(){return l.createElement("div",{className:"jcad-Mainview",style:{border:this.state.remoteUser?`solid 3px ${this.state.remoteUser.color}`:"unset"}},l.createElement(M,{loading:this.state.loading}),l.createElement(y,{remoteUser:this.state.remoteUser}),Object.entries(this.state.annotations).map((([e,t])=>{if(!this._model.annotationModel)return null;const i=this._computeAnnotationPosition(t);return l.createElement("div",{key:e,id:e,style:{left:i.x,top:i.y},className:"jcad-Annotation-Wrapper"},l.createElement(f,{itemId:e,model:this._model.annotationModel,open:!1}))})),l.createElement("div",{ref:this.divRef,style:{width:"100%",height:"calc(100%)"}}))}}class S extends _.ReactWidget{constructor(e){super(),this._mainViewModel=e.mainViewModel,this.addClass("jp-jupytercad-panel")}render(){return l.createElement(j,{viewModel:this._mainViewModel})}}var P=i(54006),x=i(33647),O=i(30427),k=i(17088),E=i(68211),I=i(80185);class R{constructor(e){this._dryRunResponses={},this._postWorkerId=new Map,this._firstRender=!0,this._renderSignal=new O.Signal(this),this._workerBusy=new O.Signal(this),this._isDisposed=!1,this._jcadModel=e.jcadModel,this._viewSetting=e.viewSetting,this._workerRegistry=e.workerRegistry}get isDisposed(){return this._isDisposed}get id(){return this._id}get renderSignal(){return this._renderSignal}get workerBusy(){return this._workerBusy}get jcadModel(){return this._jcadModel}get viewSettingChanged(){return this._viewSetting.changed}dispose(){this._isDisposed||(this._jcadModel.sharedObjectsChanged.disconnect(this._onSharedObjectsChanged,this),this._isDisposed=!0)}initSignal(){this._jcadModel.sharedObjectsChanged.connect(this._onSharedObjectsChanged,this)}initWorker(){this._worker=this._workerRegistry.getDefaultWorker(),this._id=this._worker.register({messageHandler:this.messageHandler.bind(this)}),this._workerRegistry.getAllWorkers().forEach((e=>{const t=e.register({messageHandler:this.postProcessWorkerHandler.bind(this)});this._postWorkerId.set(t,e)}))}messageHandler(e){switch(e.action){case k.MainAction.DISPLAY_SHAPE:{const{result:t,postResult:i}=e.payload,s={},n={};if(Object.entries(i).forEach((([e,t])=>{var i,o;const a=null===(o=null===(i=t.jcObject)||void 0===i?void 0:i.shapeMetadata)||void 0===o?void 0:o.shapeFormat;a===k.JCadWorkerSupportedFormat.BREP?s[e]=t:a===k.JCadWorkerSupportedFormat.GLTF&&(n[e]=t)})),this._firstRender){const e=this._jcadModel.sharedModel.outputs;this._renderSignal.emit({shapes:t,postShapes:e,postResult:n}),this._firstRender=!1}else this._renderSignal.emit({shapes:t,postShapes:null,postResult:n}),this.sendRawGeometryToWorker(s);this._workerBusy.emit(!1);break}case k.MainAction.DRY_RUN_RESPONSE:this._dryRunResponses[e.payload.id].resolve(e.payload);break;case k.MainAction.INITIALIZED:{if(!this._jcadModel)return;const e=this._jcadModel.getContent();this._workerBusy.emit(!0),this._postMessage({action:k.WorkerAction.LOAD_FILE,payload:{content:e}})}}}sendRawGeometryToWorker(e){Object.values(e).forEach((e=>{this._postWorkerId.forEach(((t,i)=>{var s,n;if(!e.jcObject.shape)return;const{shapeFormat:o,workerId:a}=null!==(n=null===(s=e.jcObject)||void 0===s?void 0:s.shapeMetadata)&&void 0!==n?n:{};t===this._workerRegistry.getWorker(null!=a?a:"")&&t.shapeFormat===o&&t.postMessage({id:i,action:k.WorkerAction.POSTPROCESS,payload:e})}))}))}async dryRun(e){await this._worker.ready;const t=E.UUID.uuid4();this._dryRunResponses[t]=new E.PromiseDelegate,this._workerBusy.emit(!0),this._postMessage({action:k.WorkerAction.DRY_RUN,payload:{id:t,content:e}});const i=await this._dryRunResponses[t].promise;return delete this._dryRunResponses[t],this._workerBusy.emit(!1),i}postProcessWorkerHandler(e){switch(e.action){case k.MainAction.DISPLAY_POST:{const t={};e.payload.forEach((e=>{const{jcObject:i,postResult:s}=e;this._jcadModel.sharedModel.setOutput(i.name,s),t[i.name]=s})),this._renderSignal.emit({shapes:null,postShapes:t});break}}}addAnnotation(e){var t;null===(t=this._jcadModel.annotationModel)||void 0===t||t.addAnnotation((0,I.A)(),e)}_postMessage(e){if(this._worker){const t=Object.assign(Object.assign({},e),{id:this._id});this._worker.postMessage(t)}}async _onSharedObjectsChanged(e,t){if(t.objectChange){await this._worker.ready;const e=this._jcadModel.getContent();this._workerBusy.emit(!0),this._postMessage({action:k.WorkerAction.LOAD_FILE,payload:{content:e}})}}}var V=i(5514);class A extends a.BoxPanel{constructor(e){super({direction:"top-to-bottom"}),this._resize=(0,v.sg)((()=>{window.dispatchEvent(new Event("resize"))}),200),this.addClass("jpcad-console");const{manager:t,contentFactory:i,mimeTypeService:s,rendermime:n}=e,o=n.clone();this._consolePanel=new V.ConsolePanel({manager:t,contentFactory:i,mimeTypeService:s,rendermime:o,kernelPreference:{name:"python3",shutdownOnDispose:!0}}),this._consolePanel.console.node.dataset.jpInteractionMode="notebook",this.addWidget(this._consolePanel),a.BoxPanel.setStretch(this._consolePanel,1),this._consolePanel.toolbar.addItem("spacer",g.Toolbar.createSpacerItem()),this._consolePanel.toolbar.addItem("toggle",new g.CommandToolbarButton({label:"",icon:g.expandIcon,id:"jupytercad:toggleConsole",commands:e.commandRegistry})),this._consolePanel.toolbar.addItem("close",new g.CommandToolbarButton({label:"",icon:g.closeIcon,id:"jupytercad:removeConsole",commands:e.commandRegistry}))}get consolePanel(){return this._consolePanel}dispose(){this.isDisposed||(this._consolePanel.dispose(),super.dispose())}execute(){this._consolePanel.console.execute(!1)}onResize(e){super.onResize(e),this._resize()}}class T extends P.DocumentWidget{constructor(e){super(e),this.onResize=e=>{window.dispatchEvent(new Event("resize"))}}dispose(){this.content.dispose(),super.dispose()}}class D extends a.SplitPanel{constructor(e){super({orientation:"vertical",spacing:0}),this._consoleOpened=!1;const{model:t,workerRegistry:i,consoleTracker:s}=e,n=function(e,t){var i={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(i[s[n]]=e[s[n]])}return i}(e,["model","workerRegistry","consoleTracker"]);this._initModel({model:t,workerRegistry:i}),this._initView(),this._consoleOption=n,this._consoleTracker=s}_initModel(e){this._view=new x.ObservableMap,this._mainViewModel=new R({jcadModel:e.model,workerRegistry:e.workerRegistry,viewSetting:this._view})}_initView(){this._jupyterCadMainViewPanel=new S({mainViewModel:this._mainViewModel}),this.addWidget(this._jupyterCadMainViewPanel),a.SplitPanel.setStretch(this._jupyterCadMainViewPanel,1)}get jupyterCadMainViewPanel(){return this._jupyterCadMainViewPanel}get viewChanged(){return this._view.changed}dispose(){this.isDisposed||(this._consoleView&&this._consoleView.dispose(),O.Signal.clearData(this),this._mainViewModel.dispose(),super.dispose())}get currentViewModel(){return this._mainViewModel}get axes(){return this._view.get("axes")}set axes(e){this._view.set("axes",e||null)}get explodedView(){return this._view.get("explodedView")}set explodedView(e){this._view.set("explodedView",e||null)}get cameraSettings(){return this._view.get("cameraSettings")}set cameraSettings(e){this._view.set("cameraSettings",e||null)}get clipView(){return this._view.get("clipView")}set clipView(e){this._view.set("clipView",e||null)}get consolePanel(){var e;return null===(e=this._consoleView)||void 0===e?void 0:e.consolePanel}deleteAxes(){this._view.delete("axes")}get wireframe(){return this._view.get("wireframe")}set wireframe(e){this._view.set("wireframe",e)}executeConsole(){this._consoleView&&this._consoleView.execute()}removeConsole(){this._consoleView&&(this._consoleView.dispose(),this._consoleView=void 0,this._consoleOpened=!1,setTimeout((()=>{window.dispatchEvent(new Event("resize"))}),250))}async toggleConsole(e){if(this._consoleView)this._consoleOpened?(this._consoleOpened=!1,this.setRelativeSizes([1,0])):(this._consoleOpened=!0,this.setRelativeSizes([2,1]));else{const{contentFactory:t,manager:i,mimeTypeService:s,rendermime:n,commandRegistry:o}=this._consoleOption;if(t&&i&&s&&n&&o&&this._consoleTracker){this._consoleView=new A({contentFactory:t,manager:i,mimeTypeService:s,rendermime:n,commandRegistry:o});const{consolePanel:a}=this._consoleView;this._consoleTracker.widgetAdded.emit(a),await a.sessionContext.ready,await a.console.inject(`from jupytercad_lab import CadDocument\ndoc = CadDocument("${e}")`),this.addWidget(this._consoleView),this.setRelativeSizes([2,1]),this._consoleOpened=!0,a.console.sessionContext.kernelChanged.connect(((e,t)=>{t.newValue||this.removeConsole()}))}}setTimeout((()=>{window.dispatchEvent(new Event("resize"))}),250)}}class L extends l.Component{constructor(e){super(e);const t=()=>{this.forceUpdate()};this._model=e.model,this._model.contextChanged.connect((async()=>{var i,s,n,o,a,r,l,d;await(null===(s=null===(i=this._model)||void 0===i?void 0:i.context)||void 0===s?void 0:s.ready),null===(a=null===(o=null===(n=this._model)||void 0===n?void 0:n.context)||void 0===o?void 0:o.model)||void 0===a||a.sharedMetadataChanged.disconnect(t),this._model=e.model,null===(d=null===(l=null===(r=this._model)||void 0===r?void 0:r.context)||void 0===l?void 0:l.model)||void 0===d||d.sharedMetadataChanged.connect(t),this.forceUpdate()}))}render(){var e;const t=null===(e=this._model)||void 0===e?void 0:e.getAnnotationIds();if(!t||!this._model)return l.createElement("div",null);const i=t.map((e=>l.createElement("div",null,l.createElement(b,{model:this._model,itemId:e}),l.createElement("hr",{className:"jpcad-Annotations-Separator"}))));return l.createElement("div",null,i)}}class B extends g.PanelWithToolbar{constructor(e){super({}),this.title.label="Annotations",this.addClass("jpcad-Annotations"),this._model=e.model,this._widget=g.ReactWidget.create(l.createElement(L,{model:this._model})),this.addWidget(this._widget)}}var G=i(41399);class W extends a.Widget{constructor(){super({node:F()}),this.title.changed.connect((e=>{this.node.textContent=this.title.label}))}}function F(){const e=document.createElement("h2");return e.textContent="-",e}var N=i(28307);class U extends g.SidePanel{constructor(e){super(),this.addClass("jpcad-sidepanel-widget"),this._model=e.model,this._annotationModel=e.annotationModel;const t=new W;this.header.addWidget(t);const i=new N.u({controlPanelModel:this._model});this.addWidget(i);const s=new B({model:this._annotationModel});this.addWidget(s),e.tracker.currentChanged.connect(((i,s)=>{var n;s?(t.title.label=s.context.localPath,this._annotationModel.context=(null===(n=e.tracker.currentWidget)||void 0===n?void 0:n.context)||void 0):(t.title.label="-",this._annotationModel.context=void 0)}))}dispose(){super.dispose()}}class q{constructor(e){this._tracker=e.tracker,this._documentChanged=this._tracker.currentChanged}get documentChanged(){return this._documentChanged}get filePath(){var e;return null===(e=this._tracker.currentWidget)||void 0===e?void 0:e.context.localPath}get jcadModel(){var e;return null===(e=this._tracker.currentWidget)||void 0===e?void 0:e.context.model}get sharedModel(){var e;return null===(e=this._tracker.currentWidget)||void 0===e?void 0:e.context.model.sharedModel}disconnect(e){this._tracker.forEach((t=>{t.context.model.sharedObjectsChanged.disconnect(e),t.context.model.sharedOptionsChanged.disconnect(e),t.context.model.sharedMetadataChanged.disconnect(e)})),this._tracker.forEach((t=>t.context.model.themeChanged.disconnect(e))),this._tracker.forEach((t=>t.context.model.clientStateChanged.disconnect(e)))}}class z extends g.PanelWithToolbar{constructor(e){super(e),this.title.label="Objects Properties";const t=_.ReactWidget.create(l.createElement(H,{cpModel:e.controlPanelModel,tracker:e.tracker,formSchemaRegistry:e.formSchemaRegistry}));this.addWidget(t),this.addClass("jpcad-sidebar-propertiespanel")}}class H extends l.Component{constructor(e){var t,i;super(e),this.syncSelectedField=(e,t,i)=>{var s;let n=null;if(e){const t=e.split("_")[0];n=e.substring(t.length)}null===(s=this.props.cpModel.jcadModel)||void 0===s||s.syncSelectedPropField({parentType:i,id:n,value:t})},this._sharedJcadModelChanged=(e,t)=>{this.setState((e=>{var t,i;if(e.selectedObject){const i=null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject();if(i){const t=(0,v.vP)(e.selectedObject,i);if(!t)return e;const s=t.parameters;return Object.assign(Object.assign({},e),{jcadObject:i,selectedObjectData:s})}return e}return Object.assign(Object.assign({},e),{jcadObject:null===(i=this.props.cpModel.jcadModel)||void 0===i?void 0:i.getAllObject()})}))},this._onClientSharedStateChanged=(e,t)=>{var i,s,n,o,a,r,l,d,c;const h=null===(s=null===(i=this.props.cpModel.jcadModel)||void 0===i?void 0:i.localState)||void 0===s?void 0:s.remoteUser,m=this.state.clientId;let p;if(h){p=t.get(h);const e=null===(n=null==p?void 0:p.selectedPropField)||void 0===n?void 0:n.id,i=null===(o=null==p?void 0:p.selectedPropField)||void 0===o?void 0:o.value;"panel"===(null===(a=null==p?void 0:p.selectedPropField)||void 0===a?void 0:a.parentType)&&(this._lastSelectedPropFieldId=(0,v.tn)(`${this.state.filePath}::panel`,e,i,null===(r=null==p?void 0:p.user)||void 0===r?void 0:r.color,this._lastSelectedPropFieldId))}else{const e=m?t.get(m):null;this._lastSelectedPropFieldId&&((0,v.TG)(`${this.state.filePath}::panel`,this._lastSelectedPropFieldId,["border-color","box-shadow"]),this._lastSelectedPropFieldId=void 0),e&&(null===(l=e.selected)||void 0===l?void 0:l.emitter)&&e.selected.emitter!==this.state.id&&(null===(d=e.selected)||void 0===d?void 0:d.value)&&(p=e)}if(p){const e=p.selected.value,t=Object.keys(e||{});if(void 0===e||1!==t.length)return void this.setState((e=>Object.assign(Object.assign({},e),{schema:void 0,selectedObject:"",selectedObjectData:void 0})));let i=t[0];if(e[i]&&"shape"!==e[i].type&&(i=e[i].parent),i!==this.state.selectedObject){const e=null===(c=this.props.cpModel.jcadModel)||void 0===c?void 0:c.getAllObject();if(e){let t;const s=(0,v.vP)(i,e);if(!s)return;s.shape&&(t=this._formSchema.get(s.shape));const n=s.parameters;this.setState((e=>Object.assign(Object.assign({},e),{selectedObjectData:n,selectedObject:i,schema:t})))}}}},this.state={filePath:this.props.cpModel.filePath,jcadObject:null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject(),clientId:null,id:(0,I.A)()},this._formSchema=e.formSchemaRegistry.getSchemas(),null===(i=this.props.cpModel.jcadModel)||void 0===i||i.sharedObjectsChanged.connect(this._sharedJcadModelChanged),this.props.cpModel.documentChanged.connect(((e,t)=>{t?(this.props.cpModel.disconnect(this._sharedJcadModelChanged),this.props.cpModel.disconnect(this._onClientSharedStateChanged),t.context.model.sharedObjectsChanged.connect(this._sharedJcadModelChanged),t.context.model.clientStateChanged.connect(this._onClientSharedStateChanged),this.setState((e=>{var i;return Object.assign(Object.assign({},e),{filePath:t.context.localPath,jcadObject:null===(i=this.props.cpModel.jcadModel)||void 0===i?void 0:i.getAllObject(),clientId:t.context.model.getClientId()})}))):this.setState({jcadOption:void 0,filePath:void 0,jcadObject:void 0,selectedObjectData:void 0,selectedObject:void 0,schema:void 0})}))}async syncObjectProperties(e,t){var i,s;if(!this.state.jcadObject||!e)return;const n=this.props.tracker.currentWidget;if(!n)return;const o=this.props.cpModel.jcadModel;if(!o)return;const a=o.getContent();for(const i of a.objects)i.name===e&&(i.parameters=Object.assign(Object.assign({},i.parameters),t));const r=await n.content.currentViewModel.dryRun(a);if("error"===r.status)return void(0,_.showErrorMessage)("Failed to update the shape","The tool was unable to update the desired shape due to invalid parameter values. The values you entered may not be compatible with the dimensions of your piece.");const l=null!==(s=null===(i=r.shapeMetadata)||void 0===i?void 0:i[e])&&void 0!==s?s:{},d=o.sharedModel.getObjectByName(e);d&&o.sharedModel.updateObjectByName(e,{data:{key:"parameters",value:Object.assign(Object.assign({},d.parameters),t)},meta:l})}render(){var e;const t=this.state.schema;if(t){const i=null===(e=this.props.cpModel.jcadModel)||void 0===e?void 0:e.getAllObject().reduce(((e,t)=>(t.name!==this.state.selectedObject&&e.push(t.name),e)),[]);for(const e in t.properties){const s=t.properties[e].fcType;if(s){const n=t.properties[e];switch(s){case"App::PropertyLink":n.enum=i;break;case"App::PropertyLinkList":n.items.enum=i}}}}return this.state.schema&&this.state.selectedObjectData?l.createElement(G.d,{parentType:"panel",filePath:`${this.state.filePath}::panel`,schema:t,sourceData:this.state.selectedObjectData,syncData:e=>{this.syncObjectProperties(this.state.selectedObject,e)},syncSelectedField:this.syncSelectedField}):l.createElement("div",null)}}class $ extends g.SidePanel{constructor(e){super(),this.addClass("jpcad-sidepanel-widget"),this._model=e.model;const t=new W;this.header.addWidget(t);const i=new z({controlPanelModel:this._model,formSchemaRegistry:e.formSchemaRegistry,tracker:e.tracker});this.addWidget(i),this._model.documentChanged.connect(((e,s)=>{s?s.context.model.sharedModel.editable?(t.title.label=s.context.localPath,i.show()):(t.title.label=`${s.context.localPath} - Read Only`,i.hide()):t.title.label="-"}))}dispose(){super.dispose()}}var J=i(25674),Y=i(9144),Q=i(64769),Z=i(99691),X=i(61493);class K extends l.Component{constructor(e){super(e),this.selectUser=e=>{var t;let i;e.userId!==(null===(t=this.state.selectedUser)||void 0===t?void 0:t.userId)&&(i=e),this.setState((e=>Object.assign(Object.assign({},e),{selectedUser:i})),(()=>{this._model.setUserToFollow(null==i?void 0:i.userId)}))},this._model=e.model,this.state={usersList:[]}}componentDidMount(){this.setState((e=>Object.assign(Object.assign({},e),{usersList:this._model.users}))),this._model.userChanged.connect(((e,t)=>{this.setState((e=>Object.assign(Object.assign({},e),{usersList:t})))}))}createUserIcon(e){var t;let i;const{userId:s,userData:n}=e,o=s===(null===(t=this.state.selectedUser)||void 0===t?void 0:t.userId)?"selected":"";return i=n.avatar_url?l.createElement("div",{key:s,title:n.display_name,className:`lm-MenuBar-itemIcon jp-MenuBar-imageIcon ${o}`,onClick:()=>this.selectUser(e)},l.createElement("img",{src:n.avatar_url,alt:""})):l.createElement("div",{key:s,title:n.display_name,className:`lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon ${o}`,style:{backgroundColor:n.color},onClick:()=>this.selectUser(e)},l.createElement("span",null,n.initials)),i}filterDuplicated(e){var t;const i=[],s=new Set;for(const n of e)(null===(t=null==n?void 0:n.userData)||void 0===t?void 0:t.username)&&!s.has(n.userData.username)&&(s.add(n.userData.username),i.push(n));return i}render(){return l.createElement("div",{className:"jpcad-toolbar-usertoolbar"},this.filterDuplicated(this.state.usersList).map((e=>{if(e.userId!==this._model.currentUserId)return this.createUserIcon(e)})))}}const ee="jcad-Toolbar-Separator";class te extends a.Widget{constructor(){super(),this.addClass(ee)}}class ie extends g.ReactiveToolbar{constructor(e){super(),this.addClass("jpcad-toolbar-widget"),setTimeout((()=>{var t;e.commands&&(this.addItem("undo",new _.CommandToolbarButton({id:s.qs.undo,label:"",icon:g.undoIcon,commands:e.commands})),this.addItem("redo",new _.CommandToolbarButton({id:s.qs.redo,label:"",icon:g.redoIcon,commands:e.commands})),this.addItem("separator1",new te),this.addItem("New Box",new _.CommandToolbarButton({id:s.qs.newBox,label:"",commands:e.commands})),this.addItem("New Cylinder",new _.CommandToolbarButton({id:s.qs.newCylinder,label:"",commands:e.commands})),this.addItem("New Sphere",new _.CommandToolbarButton({id:s.qs.newSphere,label:"",commands:e.commands})),this.addItem("New Cone",new _.CommandToolbarButton({id:s.qs.newCone,label:"",commands:e.commands})),this.addItem("New Torus",new _.CommandToolbarButton({id:s.qs.newTorus,label:"",commands:e.commands})),this.addItem("separator2",new te),this.addItem("Cut",new _.CommandToolbarButton({id:s.qs.cut,label:"",commands:e.commands})),this.addItem("Union",new _.CommandToolbarButton({id:s.qs.union,label:"",commands:e.commands})),this.addItem("Intersection",new _.CommandToolbarButton({id:s.qs.intersection,label:"",commands:e.commands})),this.addItem("Extrusion",new _.CommandToolbarButton({id:s.qs.extrusion,label:"",commands:e.commands})),this.addItem("separator3",new te),this.addItem("Chamfer",new _.CommandToolbarButton({id:s.qs.chamfer,label:"",commands:e.commands})),this.addItem("Fillet",new _.CommandToolbarButton({id:s.qs.fillet,label:"",commands:e.commands})),this.addItem("separator4",new te),this.addItem("New Sketch",new _.CommandToolbarButton({id:s.qs.newSketch,label:"",commands:e.commands})),this.addItem("separator5",new te),this.addItem("Axes Helper",new _.CommandToolbarButton({id:s.qs.updateAxes,label:"",commands:e.commands})),this.addItem("Exploded View",new _.CommandToolbarButton({id:s.qs.updateExplodedView,label:"",commands:e.commands})),this.addItem("Camera Settings",new _.CommandToolbarButton({id:s.qs.updateCameraSettings,label:"",commands:e.commands})),this.addItem("Clip View",new _.CommandToolbarButton({id:s.qs.updateClipView,label:"",commands:e.commands})),this.addItem("separator6",new te),this.addItem("Toggle console",new _.CommandToolbarButton({id:s.qs.toggleConsole,commands:e.commands,label:"",icon:g.terminalIcon})),this.addItem("Toggle Wireframe",new _.CommandToolbarButton({id:s.qs.wireframe,label:"",commands:e.commands})),this.addItem("separator7",new te),(null!==(t=e.externalCommands)&&void 0!==t?t:[]).forEach((t=>{var i;this.addItem(t.name,new _.CommandToolbarButton({id:t.id,label:null!==(i=t.label)&&void 0!==i?i:"",commands:e.commands}))})),this.addItem("spacer",g.ReactiveToolbar.createSpacerItem()),this.addItem("users",g.ReactWidget.create(l.createElement(K,{model:e.model}))))}),100)}}class se{constructor(e){this._contextChanged=new O.Signal(this),this._updateSignal=new O.Signal(this),this.context=e.context}get updateSignal(){return this._updateSignal}get user(){return this._user}set context(e){var t;this._context=e;const i=null===(t=this._context)||void 0===t?void 0:t.model.sharedModel.awareness.getLocalState();this._user=null==i?void 0:i.user,this._contextChanged.emit(void 0)}get context(){return this._context}get contextChanged(){return this._contextChanged}update(){this._updateSignal.emit(null)}getAnnotation(e){var t;const i=null===(t=this._context)||void 0===t?void 0:t.model.sharedModel.getMetadata(e);if(i)return JSON.parse(i)}getAnnotationIds(){var e;const t=[];for(const i in null===(e=this._context)||void 0===e?void 0:e.model.sharedModel.metadata)i.startsWith("annotation")&&t.push(i);return t}addAnnotation(e,t){var i;null===(i=this._context)||void 0===i||i.model.sharedModel.setMetadata(`annotation_${e}`,JSON.stringify(t))}removeAnnotation(e){var t;null===(t=this._context)||void 0===t||t.model.removeMetadata(e)}addContent(e,t){var i;const s={value:t,user:this._user},n=this.getAnnotation(e);if(n){const t=Object.assign(Object.assign({},n),{contents:[...n.contents,s]});null===(i=this._context)||void 0===i||i.model.sharedModel.setMetadata(e,JSON.stringify(t))}}}}}]);