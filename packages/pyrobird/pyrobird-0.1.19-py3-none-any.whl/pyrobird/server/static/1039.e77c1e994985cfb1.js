"use strict";(self.webpackChunkfirebird=self.webpackChunkfirebird||[]).push([[1039],{1039:(L,B,a)=>{a.r(B),a.d(B,{SceneTreeComponent:()=>x});var R=a(7358),E=a(4109),y=a(9213),N=a(8834),V=a(3973),h=a(3137),g=a(4823),t=a(4438),l=a(1632),_=a(3257);function T(C,U){if(1&C){const n=t.RV6();t.j41(0,"mat-tree-node",6),t.nrm(1,"button",7),t.EFF(2),t.j41(3,"button",8),t.bIt("click",function(){const r=t.eBV(n).$implicit,b=t.XpG();return t.Njj(b.toggleVisibility(r))}),t.j41(4,"mat-icon"),t.EFF(5),t.k0s()()()}if(2&C){const n=U.$implicit;t.R7$(2),t.SpI(" ",n.name," "),t.R7$(3),t.JRh(n.visible?"visibility":"visibility_off")}}function c(C,U){if(1&C){const n=t.RV6();t.j41(0,"mat-tree-node",9),t.bIt("mouseenter",function(){const r=t.eBV(n).$implicit,b=t.XpG();return t.Njj(b.highlightNode(r))})("mouseleave",function(){const r=t.eBV(n).$implicit,b=t.XpG();return t.Njj(b.unhighlightElement(r))}),t.j41(1,"button",10)(2,"mat-icon",11),t.EFF(3),t.k0s()(),t.EFF(4),t.j41(5,"button",8),t.bIt("click",function(){const r=t.eBV(n).$implicit,b=t.XpG();return t.Njj(b.toggleVisibility(r))}),t.j41(6,"mat-icon"),t.EFF(7),t.k0s()()()}if(2&C){const n=U.$implicit,m=t.XpG();t.R7$(),t.BMQ("aria-label","Toggle "+n.name),t.R7$(2),t.SpI(" ",m.treeControl.isExpanded(n)?"expand_more":"chevron_right"," "),t.R7$(),t.SpI(" ",n.name," "),t.R7$(3),t.JRh(n.visible?"visibility":"visibility_off")}}let x=(()=>{class C{constructor(n,m){this.geomService=n,this.eventDisplay=m,this.isHighlightingEnabled=!1,this._transformer=(r,b)=>({expandable:!!r.children&&r.children.length>0,name:r.name,level:b,type:r.type,object3D:r,visible:r.visible}),this.treeControl=new E.XW(r=>r.level,r=>r.expandable),this.treeFlattener=new R.yj(this._transformer,r=>r.level,r=>r.expandable,r=>r.children),this.dataSource=new R.zw(this.treeControl,this.treeFlattener),this.hasChild=(r,b)=>b.expandable,this.threeFacade=new h.c(this.eventDisplay)}ngOnInit(){this.dataSource.data=this.threeFacade.scene.children}toggleVisibility(n){this.geomService.toggleVisibility(n.object3D),n.visible=!n.visible}refreshScheneTree(){this.dataSource.data=[],this.dataSource.data=this.threeFacade.scene.children}toggleHighlighting(){this.isHighlightingEnabled=!this.isHighlightingEnabled,console.log("Highlighting is now "+(this.isHighlightingEnabled?"enabled":"disabled"))}isEventDataNode(n){let m=n;for(;m;){if(m.name.includes("EventData"))return!0;m=this.getParentNode(m)}return!1}getParentNode(n){for(let m=0;m<this.treeControl.dataNodes.length;m++){const r=this.treeControl.dataNodes[m];if(r.expandable&&this.treeControl.getLevel(r)<n.level&&this.treeControl.getDescendants(r).includes(n))return r}return null}highlightNode(n){if(!this.isHighlightingEnabled)return;const m=this.isEventDataNode(n);n.object3D.traverse(r=>{if(r instanceof V.eaF)if(r.userData.originalMaterial||(r.userData.originalMaterial=r.material),m){const $=r.material.clone();$.color.set(16776960),$.wireframe=!0,r.material=$}else r.material=new V.V9B({color:16776960,wireframe:!0})}),console.log(`Element highlighted: ${n.name}`)}unhighlightElement(n){this.isHighlightingEnabled&&(n.object3D.traverse(m=>{m instanceof V.eaF&&m.userData.originalMaterial&&(m.material=m.userData.originalMaterial)}),console.log(`Element unhighlighted: ${n.name}`))}static{this.\u0275fac=function(m){return new(m||C)(t.rXU(l.Ab),t.rXU(_.Oz))}}static{this.\u0275cmp=t.VBU({type:C,selectors:[["app-geometry-tree"]],standalone:!0,features:[t.aNF],decls:10,vars:4,consts:[[1,"header"],["mat-icon-button","","aria-label","Toggle Highlight","matTooltip","Toggle highlight function",3,"click"],["mat-icon-button","","aria-label","Refresh","matTooltip","Refresh tree with current geometry",3,"click"],[3,"dataSource","treeControl"],["matTreeNodePadding","",4,"matTreeNodeDef"],["matTreeNodePadding","",3,"mouseenter","mouseleave",4,"matTreeNodeDef","matTreeNodeDefWhen"],["matTreeNodePadding",""],["mat-icon-button","","disabled",""],["mat-icon-button","",3,"click"],["matTreeNodePadding","",3,"mouseenter","mouseleave"],["mat-icon-button","","matTreeNodeToggle",""],[1,"mat-icon-rtl-mirror"]],template:function(m,r){1&m&&(t.j41(0,"div",0)(1,"button",1),t.bIt("click",function(){return r.toggleHighlighting()}),t.j41(2,"mat-icon"),t.EFF(3),t.k0s()(),t.j41(4,"button",2),t.bIt("click",function(){return r.refreshScheneTree()}),t.j41(5,"mat-icon"),t.EFF(6,"refresh"),t.k0s()()(),t.j41(7,"mat-tree",3),t.DNE(8,T,6,2,"mat-tree-node",4)(9,c,8,4,"mat-tree-node",5),t.k0s()),2&m&&(t.R7$(3),t.JRh(r.isHighlightingEnabled?"highlight_off":"highlight"),t.R7$(4),t.Y8G("dataSource",r.dataSource)("treeControl",r.treeControl),t.R7$(2),t.Y8G("matTreeNodeDefWhen",r.hasChild))},dependencies:[R.lQ,R.d6,N.iY,R.pO,R.yI,y.An,R.yF,g.oV],styles:[".header[_ngcontent-%COMP%]{display:flex;justify-content:flex-end}.header[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:48px;height:48px;min-width:48px;color:#fff;padding-top:8px}mat-tree[_ngcontent-%COMP%]{background-color:#2e2e2e}"]})}}return C})()},1632:(L,B,a)=>{a.d(B,{Ns:()=>X,Ab:()=>z});var R=a(467),E=a(5304),y=a(6168);function N(e,s,o=0,i=0,f="",p){const d=e.fName,v=void 0===e.fMasterVolume?e.fVolume:e.fMasterVolume,O=v?v.fNodes:null,u=f?`${f}/${d}`:d;let G=1,F=!0;if((!p||(0,y.T)(u,p))&&s&&(F=s(e,u,i),!F))return G;if(v&&O&&i<o)for(let k=0;k<O.arr.length;k++){const A=O.arr[k];A&&(G+=N(A,s,o,i+1,u,p))}return G}function h(e,s,o=1/0){let i=function V(e,s,o=1/0){let i=[];return N(e,(p,d,v)=>(i.push({geoNode:p,fullPath:d}),!0),o,0,"",s),i}(e,s,o);if(null==i)return null;if(i.length>1)throw new Error(`findSingleGeoNode of ${e} returned more than 1 result (${i.length})`);return 0==i.length?null:i[0].geoNode}function t(e,s=1){let o=[];return N(e,(f,p,d)=>d!=s||(o.push({geoNode:f,fullPath:p}),!1),s),o}function _(){return(_=(0,R.A)(function*(e){for(const s of e.fKeys)if("TGeoManager"===s.fClassName)return e.readObject(s.fName);return null})).apply(this,arguments)}var T=a(4491),c=function(e){return e[e.kVisOverride=1]="kVisOverride",e[e.kVisNone=2]="kVisNone",e[e.kVisThis=4]="kVisThis",e[e.kVisDaughters=8]="kVisDaughters",e[e.kVisOneLevel=16]="kVisOneLevel",e[e.kVisStreamed=32]="kVisStreamed",e[e.kVisTouched=64]="kVisTouched",e[e.kVisOnScreen=128]="kVisOnScreen",e[e.kVisContainers=4096]="kVisContainers",e[e.kVisOnly=8192]="kVisOnly",e[e.kVisBranch=16384]="kVisBranch",e[e.kVisRaytrace=32768]="kVisRaytrace",e}(c||{});function x(e,s,o){void 0!==e.fGeoAtt&&(e.fGeoAtt=o?e.fGeoAtt|s:e.fGeoAtt&~s)}function C(e,s){void 0!==e.fGeoAtt&&(e.fGeoAtt=e.fGeoAtt^16777215&s)}var n=function(e){return e[e.Nothing=0]="Nothing",e[e.Remove=1]="Remove",e[e.RemoveSiblings=2]="RemoveSiblings",e[e.RemoveChildren=3]="RemoveChildren",e[e.RemoveBySubLevel=4]="RemoveBySubLevel",e[e.SetGeoBit=5]="SetGeoBit",e[e.UnsetGeoBit=6]="UnsetGeoBit",e[e.ToggleGeoBit=7]="ToggleGeoBit",e}(n||{});function r(e,s,o=1/0){let i=[],f=[...s];N(e,(d,v,O)=>{for(const u of f)if(void 0===v&&console.log("nodeFullPath == undefined"),void 0===u?.pattern&&console.log(`rule?.pattern == undefined ${u}`),(0,y.T)(v,u.pattern)){if(u.childrenRules?.length&&r(d,u.childrenRules,u.childrenRulesMaxLevel??1/0),u.action===n.Remove)return b(d),!1;if(u.action===n.RemoveChildren)return $(d),!1;(u.action===n.RemoveSiblings||u.action===n.RemoveBySubLevel)&&i.push({node:d,fullPath:v,rule:u}),u.action===n.SetGeoBit&&void 0!==u.geoBit&&x(d.fVolume,u.geoBit,1),u.action===n.UnsetGeoBit&&void 0!==u.geoBit&&x(d.fVolume,u.geoBit,0),u.action===n.ToggleGeoBit&&void 0!==u.geoBit&&C(d.fVolume,u.geoBit)}return!0},o);for(let d of i){let v=d.node,O=v.fullPath,u=d.rule,G=d.node.fMother,F=G?.fNodes?.arr;if(u.action==n.RemoveSiblings&&(F?G.fNodes.arr=[v]:console.log(`Can't get an array for: ${v} at ${O}`)),u.action==n.RemoveBySubLevel){let k=t(v,u.pruneSubLevel);for(const A of k)b(A.geoNode)}}return i}function b(e){let o=e.fMother?.fNodes?.arr;if(o){const i=o.indexOf(e);-1!==i?o.splice(i,1):console.warn(`Item ${e} not found in array???`)}else console.warn(`Can't get siblings of ${e}`)}function $(e){e.fVolume?.fNodes?.arr?e.fVolume.fNodes.arr=[]:console.log(`Can't get child nodes of ${e}`)}class W{constructor(){this.removeDetectorNames=["Lumi","B1","B2","Q2","ForwardOffM","Forward","Backward","Vacuum","SweeperMag","AnalyzerMag","ZDC","HcalFarForward","InnerTrackingSupport"],this.subDetectorsRules=[{namePattern:"*/EcalBarrelScFi*",editRules:[{pattern:"*/fiber_grid*",action:n.Remove},{pattern:"*",action:n.SetGeoBit,geoBit:c.kVisDaughters},{pattern:"*/*layer*",action:n.SetGeoBit,geoBit:c.kVisThis},{pattern:"*/*layer*",action:n.UnsetGeoBit,geoBit:c.kVisNone},{pattern:"*/*layer*",action:n.UnsetGeoBit,geoBit:c.kVisDaughters}]},{namePattern:"*/EcalBarrelImaging*",editRules:[{pattern:"*/stav*",action:n.RemoveChildren},{pattern:"*",action:n.SetGeoBit,geoBit:c.kVisDaughters}]},{namePattern:"*/DRICH*",editRules:[{pattern:"*/DRICH_cooling*",action:n.RemoveSiblings}]},{namePattern:"*/DIRC*",editRules:[{pattern:"*/Envelope_box*",action:n.RemoveChildren},{pattern:"*/Envelope_box*",action:n.SetGeoBit,geoBit:c.kVisThis},{pattern:"*/Envelope_box*",action:n.UnsetGeoBit,geoBit:c.kVisNone},{pattern:"*/Envelope_box*",action:n.UnsetGeoBit,geoBit:c.kVisDaughters},{pattern:"*/Envelope_lens_vol*",action:n.Remove}]},{namePattern:"*/EcalEndcapN*",editRules:[{pattern:"*/crystal*",action:n.RemoveSiblings}]},{namePattern:"*/EcalEndcapP_*",editRules:[{pattern:"*/EcalEndcapP_layer1_0*",action:n.UnsetGeoBit,geoBit:c.kVisDaughters},{pattern:"*/EcalEndcapP_layer1_0*",action:n.RemoveChildren}]},{namePattern:"*/LFHCAL_*",editRules:[{pattern:"*/LFHCAL_8M*",action:n.RemoveChildren},{pattern:"*/LFHCAL_8M*",action:n.SetGeoBit,geoBit:c.kVisThis},{pattern:"*/LFHCAL_8M*",action:n.UnsetGeoBit,geoBit:c.kVisNone},{pattern:"*/LFHCAL_8M*",action:n.UnsetGeoBit,geoBit:c.kVisDaughters}]},{namePattern:"*/HcalEndcapPInsert_23*",editRules:[{pattern:"*/*layer*slice1_*",action:n.RemoveSiblings}]},{namePattern:"*/HcalBarrel*",editRules:[{pattern:"*/Tile*",action:n.Remove},{pattern:"*/ChimneyTile*",action:n.Remove}]},{namePattern:"*/EndcapTOF*",editRules:[{pattern:"*/suppbar*",action:n.Remove},{pattern:"*/component*3",action:n.RemoveSiblings}]}]}process(s){let o=function w(e,s){const i=(void 0===e.fMasterVolume?e.fVolume:e.fMasterVolume)?.fNodes?.arr??[];let f=[];if(!i.length)return{nodes:i,removedNodes:f};for(let p of i)s.some(v=>p.fName.startsWith(v))&&f.push(p);for(let p of f)b(p);return{nodes:i,removedNodes:f}}(s,this.removeDetectorNames);console.log("Filtered top level detectors: ",o);for(let i of this.subDetectorsRules){let f=h(s,i.namePattern,1);if(console.log(`Processing ${f}`),f){console.time(`Process sub-detector: ${i.namePattern}`);for(let p of i.editRules)r(f,[p]);console.timeEnd(`Process sub-detector: ${i.namePattern}`)}}console.log(`Done processing ${this.subDetectorsRules.length} detectors`)}}var j=a(4438),K=a(7660),Q=a(3167);const P="Calorimeters",M="Tracking",I="PID",S="Magnets",D="Beam pipe and support",X=[P,M,I,S,D];let z=(()=>{class e{constructor(o,i){this.settings=o,this.urlService=i,this.rootGeometryProcessor=new W,this.subdetectors=[],this.rootGeometry=null,this.geometry=null,this.groupsByDetName=new Map([["SolenoidBarrel_assembly_0",S],["SolenoidEndcapP_1",S],["SolenoidEndcapN_2",S],["VertexBarrelSubAssembly_3",M],["InnerSiTrackerSubAssembly_4",M],["MiddleSiTrackerSubAssembly_5",M],["OuterSiTrackerSubAssembly_6",M],["EndcapMPGDSubAssembly_7",M],["InnerMPGDBarrelSubAssembly_8",M],["EndcapTOFSubAssembly_9",I],["BarrelTOFSubAssembly_10",I],["OuterBarrelMPGDSubAssembly_11",M],["B0TrackerSubAssembly_12",M],["InnerTrackerSupport_assembly_13",D],["DIRC_14",I],["RICHEndcapN_Vol_15",I],["DRICH_16",I],["EcalEndcapP_17",P],["EcalEndcapPInsert_18",P],["EcalBarrelImaging_19",P],["EcalBarrelScFi_20",P],["EcalEndcapN_21",P],["LFHCAL_env_22",P],["HcalEndcapPInsert_23",P],["HcalBarrel_24",P],["FluxBarrel_env_25",D],["FluxEndcapP_26",D],["HcalEndcapN_27",P],["FluxEndcapN_28",D],["BeamPipe_assembly_29",D],["B0PF_BeamlineMagnet_assembly_30",S],["B0APF_BeamlineMagnet_assembly_31",S],["Q1APF_BeamlineMagnet_assembly_32",S],["Q1BPF_BeamlineMagnet_assembly_33",S],["BeamPipeB0_assembly_38",D],["Pipe_cen_to_pos_assembly_39",D],["Q0EF_assembly_40",S],["Q0EF_vac_41",S],["Q1EF_assembly_42",S],["Q1EF_vac_43",S],["B0ECal_44",P],["Pipe_Q1eR_to_B2BeR_assembly_54",D],["Magnet_Q1eR_assembly_55",S],["Magnet_Q2eR_assembly_56",S],["Magnet_B2AeR_assembly_57",S],["Magnet_B2BeR_assembly_58",S],["Magnets_Q3eR_assembly_59",S]])}loadGeometry(){var o=this;return(0,R.A)(function*(){o.subdetectors=[];let i="builtin://epic-central-optimized"!==o.settings.selectedGeometry.value?o.settings.selectedGeometry.value:"https://eic.github.io/epic/artifacts/tgeo/epic_full.root";i=o.urlService.resolveUrl(i),console.time("[GeometryService]: Total load geometry time"),console.log(`[GeometryService]: Loading file ${i}`),console.time("[GeometryService]: Open root file");const f=yield(0,E.TqT)(i);if(console.timeEnd("[GeometryService]: Open root file"),console.time("[GeometryService]: Reading geometry from file"),o.rootGeometry=yield function l(e){return _.apply(this,arguments)}(f),console.log("Got TGeoManager. For inspection:"),console.log(o.rootGeometry),console.timeEnd("[GeometryService]: Reading geometry from file"),console.time("[GeometryService]: Root geometry pre-processing"),o.rootGeometryProcessor.process(o.rootGeometry),console.time("[GeometryService]: Root geometry pre-processing"),function g(e,s=2){let o=t(e,1),i=0;console.log(`--- Detector subcomponents analysis --- Detectors: ${o.length}`);for(let f of o){let p=N(f.geoNode,null,1/0);i+=p,console.log(`${p}: ${f.fullPath}`)}console.log(`--- End of analysis --- Total elements: ${i}`)}(o.rootGeometry,1),console.time("[GeometryService]: Build geometry"),o.geometry=(0,T.build)(o.rootGeometry,{numfaces:5e9,numnodes:5e9,instancing:-1,dflt_colors:!1,vislevel:200,doubleside:!0,transparency:!0}),console.timeEnd("[GeometryService]: Build geometry"),!o.geometry)throw new Error("Geometry is null or undefined after TGeoPainter.build");if(!o.geometry.children.length)throw new Error("Geometry is converted but empty. Anticipated 'world_volume' but got nothing");if(!o.geometry.children[0].children.length)throw new Error("Geometry is converted but empty. Anticipated array of top level nodes (usually subdetectors) but got nothing");console.time("[GeometryService]: Map root geometry to threejs geometry");let p=o.geometry.children[0].children;for(const d of p){const v=d.name,G=(o.stripIdFromName(v),t(o.rootGeometry,1).map(k=>k.geoNode).find(k=>k.fName===v));let F={sourceGeometry:G,sourceGeometryName:G?.fName??"",geometry:d,name:o.stripIdFromName(v),groupName:o.groupsByDetName.get(v)||""};console.log(F.sourceGeometryName),o.subdetectors.push(F)}return console.timeEnd("[GeometryService]: Map root geometry to threejs geometry"),console.timeEnd("[GeometryService]: Total load geometry time"),{rootGeometry:o.rootGeometry,threeGeometry:o.geometry}})()}stripIdFromName(o){return o.replace(/_\d+$/,"")}toggleVisibility(o){o&&(o.visible=!o.visible,console.log(`Visibility toggled for object: ${o.name}. Now visible: ${o.visible}`))}static{this.\u0275fac=function(i){return new(i||e)(j.KVO(K.B),j.KVO(Q.H))}}static{this.\u0275prov=j.jDH({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})()},3167:(L,B,a)=>{a.d(B,{H:()=>h});var R=a(4438),E=a(7660),y=a(6978);let h=(()=>{class g{constructor(l,_){this.userConfigService=l,this.serverConfigService=_,this.userConfigHost="http://localhost:5454",this.userConfigUseApi=!1,this.userConfigService.localServerUrl.subject.subscribe(T=>{this.userConfigHost=T}),this.userConfigService.localServerUseApi.subject.subscribe(T=>{this.userConfigUseApi=T}),this.serverConfig=this.serverConfigService.config}getEndpointDownload(l){return`/api/v1/download?f=${l}`}getEndpointConvert(l,_,T="edm4eic"){return`/api/v1/convert/${T}/${_}?f=${l}`}getApiServerBase(){return this.serverConfig.servedByPyrobird?`${window.location.protocol}//${this.serverConfig.serverHost}:${this.serverConfig.serverPort}`:this.userConfigUseApi?this.userConfigHost:document.baseURI}get isBackendAvailable(){return this.serverConfig.servedByPyrobird||this.userConfigUseApi}resolveLocalhostUrl(l){if(!l.startsWith("local://"))return l;const c=l.substring(8);return this.getApiServerBase(),this.isBackendAvailable?this.getApiServerBase()+this.getEndpointDownload(c):`${this.getApiServerBase()}/${c}`}resolveUrl(l){let _=l;return l.includes("://")||(l="local://"+l),l.startsWith("asset://")?(l=l.replace("asset://",""),_=`${document.baseURI}/assets/${l}`):l.startsWith("local://")&&(_=this.resolveLocalhostUrl(l)),_}static{this.\u0275fac=function(_){return new(_||g)(R.KVO(E.B),R.KVO(y.B))}}static{this.\u0275prov=R.jDH({token:g,factory:g.\u0275fac,providedIn:"root"})}}return g})()},3137:(L,B,a)=>{a.d(B,{c:()=>R});class R{get phoenixThreeManager(){return this.phoenixEventDisplay.getThreeManager()}get activeOrbitControls(){return this.phoenixThreeManager.controlsManager.getActiveControls()}get mainCamera(){return this.phoenixThreeManager.controlsManager.getMainCamera()}get activeCamera(){return this.phoenixThreeManager.controlsManager.getActiveCamera()}get scene(){return this.phoenixThreeManager.getSceneManager().getScene()}get sceneGeometries(){return this.phoenixThreeManager.getSceneManager().getGeometries()}get mainRenderer(){return this.phoenixThreeManager.rendererManager.getMainRenderer()}get sceneEvent(){return this.phoenixThreeManager.getSceneManager().getEventData()}constructor(y){this.phoenixEventDisplay=y}}},6168:(L,B,a)=>{function R(E,y){let N=0,V=0,h=0,g=0;for(;g<E.length&&"*"!==y[h];){if(y[h]!==E[g]&&"?"!==y[h])return!1;h++,g++}for(;g<E.length;)if("*"===y[h]){if(++h===y.length)return!0;V=h,N=g+1}else if(y[h]===E[g]||"?"===y[h])h++,g++;else{if(N>E.length)return!1;h=V,g=N++}for(;h<y.length&&"*"===y[h];)h++;return h===y.length}a.d(B,{T:()=>R})}}]);