# define also stages which are used in includes
default:
  image: python:3.9-alpine

stages:
  - check
  - test  
  - quality
  - build
  - deploy


code_quality:
  stage: quality
  allow_failure: true
  before_script:
    - pip install flake8
  script:
    - python3 scripts/quality_report.py flake8_report.txt
  rules:
    - if: '$CODE_QUALITY_DISABLED'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"' # Run code quality job in merge request pipelines
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'      # Run code quality job in pipelines on the master branch (but not in other branch pipelines)
    - if: '$CI_COMMIT_TAG'                               # Run code quality job in pipelines for tags
  artifacts:
    reports:
      codequality: code-quality-report.json
    paths:
      - code-quality-report.json
    expire_in: never      
    
flake8:
  stage: check
  image: python:3.9-alpine
  allow_failure: true  
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"' # Run code quality job in merge request pipelines
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'      # Run code quality job in pipelines on the master branch (but not in other branch pipelines)
    - if: '$CI_COMMIT_TAG'                               # Run code quality job in pipelines for tags
  before_script:
    - pip install flake8
  script:
    - flake8 . --exit-zero --config setup.cfg --statistics --count --tee --output-file=flake8_report.txt
  artifacts:
    paths:
      - flake8_report.txt
