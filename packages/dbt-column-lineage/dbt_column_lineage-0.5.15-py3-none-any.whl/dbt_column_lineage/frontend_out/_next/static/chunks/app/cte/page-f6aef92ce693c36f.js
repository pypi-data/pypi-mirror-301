(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[318],{79826:function(e,s,t){Promise.resolve().then(t.bind(t,25767))},25767:function(e,s,t){"use strict";t.d(s,{Cte:function(){return C}});var l=t(57437),n=t(16463),r=t(27289),a=t(2265),o=t(6785),c=t(63775),i=t(50197);t(10715);var d=t(37215),u=t(71165),m=t(20707),h=t(20548),x=t(37642),f=t(29820),p=t.n(f),b=t(92168),g=t(19997),j=e=>{let{data:s}=e,t=(0,a.useCallback)((e,s,t)=>{e.stopPropagation();let l=s.schema,n=s.table,r=new URLSearchParams({schema:l,sources:n,activeSource:n});if(t){let e=JSON.stringify({[n]:[t]});r.set("selectedColumns",e)}window.open("/cte?".concat(r.toString()),"_blank")},[]);return(0,a.useEffect)(()=>{},[]),(0,l.jsxs)("div",{className:"relative bg-white border border-gray-300 rounded-md p-1 shadow-sm w-48 min-h-[60px] flex flex-col",children:[(0,l.jsx)(o.HH,{type:"target",position:o.Ly.Top,className:"opacity-0"}),(0,l.jsxs)("div",{className:"flex flex-col flex-grow",children:[(0,l.jsx)("div",{className:"font-semibold text-[11px] truncate mb-0.5",title:s.label,children:s.label}),(0,l.jsx)("div",{className:"flex-grow overflow-hidden",children:s.meta&&0!==s.meta.length?s.meta.map((e,s)=>(0,l.jsxs)("div",{className:"text-[9px] leading-tight font-mono whitespace-pre",children:[(0,l.jsx)("div",{className:"flex min-w-0",children:(0,l.jsx)("span",{className:"bg-amber-200 truncate",title:e.column,children:e.column})}),e.nextColumns.length>0?e.nextColumns.map((s,n)=>(0,l.jsxs)(a.Fragment,{children:[(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("span",{className:"flex-shrink-0 w-4",children:n===e.nextColumns.length-1?"└── ":"├── "}),(0,l.jsx)("span",{className:"bg-emerald-200 truncate",title:s,children:s})]}),e.nextSources[n]&&(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("span",{className:"flex-shrink-0 ".concat(n===e.nextColumns.length-1?"w-4":"w-1 mr-3"),children:n===e.nextColumns.length-1?"":"│"}),(0,l.jsx)("span",{className:"flex-shrink-0 w-4",children:"└── "}),(0,l.jsx)("span",{className:"bg-indigo-200 text-blue-700 truncate cursor-pointer underline",onClick:s=>t(s,e.nextSources[n],e.nextColumns[n]||e.column),title:e.nextSources[n].table,children:e.nextSources[n].table})]})]},n)):e.nextSources.map((s,n)=>(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("span",{className:"flex-shrink-0 w-4",children:n===e.nextSources.length-1?"└── ":"├── "}),(0,l.jsx)("span",{className:"bg-indigo-200 text-blue-700 truncate cursor-pointer underline",onClick:l=>t(l,s,e.nextColumns[n]||e.column),title:s.table,children:s.table})]},n))]},s)):null})]}),(0,l.jsx)("div",{className:"flex flex-wrap gap-0.5 mt-1",children:[{key:"groups",color:"bg-pink-500",label:"group by"},{key:"havings",color:"bg-orange-500",label:"having"},{key:"wheres",color:"bg-red-500",label:"where"},{key:"unions",color:"bg-purple-500",label:"union"},{key:"joins",color:"bg-lime-500",label:"join"}].map(e=>{let{key:t,color:n,label:r}=e,a=s[t];return Array.isArray(a)&&a.length>0?(0,l.jsxs)("div",{className:"flex items-center cursor-pointer",title:a.join("\n"),children:[(0,l.jsx)("div",{className:"w-2 h-2 ".concat(n," mr-0.5 rounded-full")}),(0,l.jsx)("span",{className:"text-[6px]",children:r})]},t):null})}),(0,l.jsx)(o.HH,{type:"source",position:o.Ly.Bottom,className:"opacity-0"})]})};let N=m.tk.theme({".cm-content":{fontFamily:"Roboto !important",fontSize:"smaller"}}),w=m.Py.define(),k=m.QQ.define({create:()=>m.p.none,update(e,s){for(let t of(e=e.map(s.changes),s.effects))t.is(w)&&(e=e.update({add:t.value,sort:!0}));return e},provide:e=>m.tk.decorations.from(e)}),v=(e,s,t)=>{let l=new(p()).graphlib.Graph;l.setDefaultEdgeLabel(()=>({})),l.setGraph({rankdir:t.rankdir,ranksep:30,nodesep:30}),s.forEach(e=>l.setEdge(e.source,e.target)),e.forEach(e=>l.setNode(e.id,{label:e.id,width:e.width,height:e.height})),p().layout(l);let n={};return s.forEach(s=>{n[s.source]||(n[s.source]=[]),n[s.source].push(e.find(e=>e.id===s.target))}),{nodes:e.map(e=>{let s=l.node(e.id),t=0;return Object.values(n).forEach(s=>{s.some(s=>s.id===e.id)&&(t=(s.findIndex(s=>s.id===e.id)-(s.length-1)/2)*100)}),{...e,position:{x:s.x-s.width/2+t,y:s.y-s.height/2}}}),edges:s}},y=e=>{let{nodes:s,edges:t,setNodes:r,setEdges:d,nodesPositioned:x,setNodesPositioned:f,codeMirrorRef:p,entireMeta:b}=e,g=(0,a.useRef)(!0),{fitView:N}=(0,o._K)(),k=(0,n.useSearchParams)(),[y,C]=(0,a.useState)(!1),S=(0,u.o)(e=>e.options),E=(0,u.o)(e=>e.setOptions),P=(0,a.useCallback)(e=>{if(null==p.current||null==p.current.view)return;let s=p.current.view,t=F(s,"".concat(e.data.label," as ("));t&&(null==s||s.dispatch({selection:{head:t[0].from,anchor:t[0].to},scrollIntoView:!0,effects:m.tk.scrollIntoView(t[0].from,{x:"start",y:"start"})}))},[k]),_=(0,a.useCallback)(()=>{if(0==s.length||x)return;let e=v(s,t,S);r([...e.nodes]),d([...e.edges]),window.requestAnimationFrame(()=>{setTimeout(()=>N(),0)}),C(!0),f(!0)},[x]),R=(0,a.useCallback)(e=>r(s=>(0,o.Fb)(e,s)),[r]),L=(0,a.useCallback)(e=>d(s=>(0,o.yn)(e,s)),[d]),T=(0,a.useCallback)(e=>d(s=>(0,o.Z_)(e,s)),[d]),F=(0,a.useCallback)((e,s)=>{let t=new h.FH(e.state.doc,s),l=[];for(let e=t.next();!e.done;e=t.next())l.push({from:e.value.from,to:e.value.to});return l},[]),O=(0,a.useCallback)((e,s,t,l)=>{let n=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new h.Zg(e.state.doc,"\\b".concat(n,"\\b"),{},t,l),a=[];for(;!r.next().done;)a.push({from:r.value.from,to:r.value.to});return a},[]),H=(0,a.useCallback)(()=>{if(0==s.length||x||null==p.current||null==p.current.view)return;let e=m.p.mark({class:"bg-amber-200"}),t=m.p.mark({class:"bg-emerald-200"}),l=m.p.mark({class:"bg-indigo-200"}),n=[],r=[],a=[],o=null;for(let s of b){let c;let i=s.column,d=s.nextColumns,u=s.nextSources,m=s.reference,h="".concat(m," as ("),x=F(p.current.view,h),f=x.length>0?x[0].from:0;if(o){let e=F(p.current.view,o);c=e.length>0?e[0].from:void 0}for(let s of O(p.current.view,i,f,c))n.push(e.range(s.from,s.to));for(let e of d)for(let s of O(p.current.view,e,f,c))r.push(t.range(s.from,s.to));for(let e of u)for(let s of O(p.current.view,e.table,f,c))a.push(l.range(s.from,s.to));o=h}p.current.view.dispatch({effects:w.of(n)}),p.current.view.dispatch({effects:w.of(r)}),p.current.view.dispatch({effects:w.of(a)})},[b,x,p.current]),Z=(0,a.useMemo)(()=>({cte:e=>(0,l.jsx)(j,{...e})}),[]);return(0,a.useEffect)(()=>{H()},[x,p.current]),(0,a.useEffect)(()=>{g.current||_()},[x]),(0,a.useEffect)(()=>{E({rankdir:"TB"}),g.current=!1},[]),(0,l.jsx)(a.Suspense,{children:(0,l.jsxs)(o.x$,{nodes:s,nodeTypes:Z,edges:t,onNodesChange:R,onEdgesChange:L,onConnect:T,onNodeClick:(e,s)=>P(s),children:[(0,l.jsx)(c.Z,{}),(0,l.jsx)(i.A,{style:{backgroundColor:"#f5f5f5"}})]})})},C=()=>{let{height:e}=(0,r.Y)(),[s,t]=(0,o.Rr)([]),[c,i]=(0,o.ll)([]),[u,h]=(0,a.useState)(!0),f=(0,a.useRef)(null),[p,j]=(0,a.useState)("lineage"),[w,v]=(0,a.useState)(""),[C,S]=(0,a.useState)(""),[E,P]=(0,a.useState)(""),[_,R]=(0,a.useState)(""),[L,T]=(0,a.useState)([]),[F,O]=(0,a.useState)([]),H=(0,n.useRouter)(),Z=(0,a.useCallback)(async e=>{let{sources:s,columns:l}=e;t([]),i([]);let n=s[0],r=l[n]?l[n][0]:"",a=new URLSearchParams({source:n,column:r}),o=await fetch("".concat("","/api/v1/cte?").concat(a)),c=await o.json();return 200!=o.status?(alert(c.error),H.back(),!1):(t(c.nodes),i(c.edges),v(c.tableName),S(c.materialized),P(c.query),R(c.description),T(c.columns),O(c.entireMeta),setTimeout(()=>h(!1),100),A(),!0)},[H]),A=(0,a.useCallback)(()=>{j("lineage"),setTimeout(()=>h(!1),100)},[j,h]);return(0,l.jsxs)("div",{children:[(0,l.jsx)(d.h,{handleFetchData:Z}),(0,l.jsxs)("div",{className:"flex flex-wrap",children:[(0,l.jsxs)("div",{className:"w-1/2",children:[(0,l.jsxs)("h4",{className:"px-1 text-2xl font-bold flex items-center",children:[(0,l.jsx)("span",{className:"select-text",children:w}),(0,l.jsx)("small",{className:"ms-2 font-semibold text-gray-500 dark:text-gray-400 select-text",children:C})]}),(0,l.jsx)("div",{className:"px-2",style:{height:.85*e,overflowY:"auto"},children:(0,l.jsx)(m.ZP,{ref:f,value:E,theme:N,extensions:[(0,x.i6)(),k]})})]}),(0,l.jsxs)("div",{className:"w-1/2",style:{height:e-55-24},children:[(0,l.jsxs)("div",{className:"mx-2",children:[(0,l.jsx)("button",{className:"px-1 "+("description"==p&&"font-semibold"),onClick:()=>j("description"),children:"Description"}),(0,l.jsx)("button",{className:"px-1 "+("columns"==p&&"font-semibold"),onClick:()=>j("columns"),children:"Columns"}),(0,l.jsx)("button",{className:"px-1 "+("lineage"==p&&"font-semibold"),onClick:()=>A(),children:"Lineage"})]}),"description"==p&&(0,l.jsx)(b.U,{className:"markdown",remarkPlugins:[g.Z],children:_}),"columns"==p&&(e=>{let{columns:s}=e;return(0,l.jsxs)("table",{className:"table-auto text-xs w-full",children:[(0,l.jsx)("thead",{className:"sticky top-0 z-10",children:(0,l.jsxs)("tr",{className:"bg-gray-200",children:[(0,l.jsx)("th",{className:"border",children:"Column"}),(0,l.jsx)("th",{className:"border",children:"Type"}),(0,l.jsx)("th",{className:"border",children:"Description"})]})}),(0,l.jsx)("tbody",{children:Object.keys(s).map((e,t)=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{className:"border",children:s[e].name.toLowerCase()}),(0,l.jsx)("td",{className:"border",children:s[e].type}),(0,l.jsx)("td",{className:"border",children:s[e].comment})]},t))})]})})({columns:L}),"lineage"==p&&(0,l.jsx)(o.tV,{children:(0,l.jsx)(y,{nodes:s,edges:c,setNodes:t,setEdges:i,codeMirrorRef:f,nodesPositioned:u,setNodesPositioned:h,entireMeta:F})})]})]})]})}}},function(e){e.O(0,[489,780,401,346,704,49,971,23,744],function(){return e(e.s=79826)}),_N_E=e.O()}]);