import{j as e,M as J,R as B,L as G,r as f,u as b,a as O,P as C,B as y,T as M,b as Q,s as g,S as j,I as S,i as A,c as D,d as V,e as H,C as W,f as z,F as N,g as Y,h as X,k as L,l as Z,m as ee,n as I,o as k,Q as te,H as re,p as se,q as ne}from"./vendor-zFT11HkH.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function a(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=a(s);fetch(s.href,o)}})();function ae(t,r,a,n,s){return{key:r,icon:a,children:n,label:t,type:s,className:"menu-item"}}const oe=()=>e.jsx(J,{mode:"inline",theme:"dark",items:[ae(e.jsx(G,{to:"/",children:"Tasks"}),"tasks",e.jsx(B,{}))]});function F(){return window.__DARQ_UI_CONFIG__}function K(t){let r=F().base_path;return r==="/"?t:r+t}function ie(t=null){let r={method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin"};return t!==null&&(r.body=JSON.stringify(t)),r}function le(){return{method:"GET",credentials:"same-origin"}}const R=async(t,r=null,a=null)=>{const n=new URLSearchParams(a),s=K(t)+(a?`?${n}`:"");try{const o=await fetch(s,ie(r));if(o.ok||o.status===400)return o.json()}catch(o){throw console.log("[POST] Fetch Error :-S",o),o}},ce=async(t,r=null)=>{const a=new URLSearchParams(r),n=K(t)+(r?`?${a}`:"");try{const s=await fetch(n,le());if(s.ok)return s.json()}catch(s){throw console.log("[GET] Fetch Error :-S",s),s}},_=(t,r)=>{g.error(`args "${t}" is invalid JSON array: ${r}`)},E=(t,r)=>{g.error(`kwargs "${t}" is invalid JSON: ${r}`)},ue=t=>{if(t===""||t===null)return[];if(Array.isArray(t))return t;let r=[];try{let a=JSON.parse(t);if(!Array.isArray(a))return _(t,"not an array"),null;r=a}catch(a){return _(t,a),null}return r},de=t=>{if(t===""||t===null)return{};if(A(t))return t;let r={};try{let a=JSON.parse(t);if(!A(a))return E(t,"not a plain object"),null;r=a}catch(a){return E(t,a),null}return r},pe=({task:t,onClick:r,setArgs:a,setKwargs:n})=>e.jsxs(j,{direction:"vertical",style:{width:"390px"},children:[e.jsxs("div",{children:["Task signature: ",t.signature]}),e.jsx(S,{label:"Positional args",placeholder:"[123, true]",onChange:s=>a(s.target.value)}),e.jsx(S,{label:"Keyword args",placeholder:'{"company_id": 123, "dry_run": true}',onChange:s=>n(s.target.value)}),e.jsx(y,{onClick:r,type:"primary",children:"Run"})]}),v=Symbol("__invalid_value__"),he=t=>t.slice(1,-1).split(",").map(a=>{const[n,s]=a.split(":").map(l=>l.trim()),o=s.split(" ")[0],u=s.split(" ")[2],p={True:"true",False:"false",None:"null"}[u]||u;return{name:n,type:o,defaultValue:p,parse:l=>{if(l==="")return p;switch(o){case"int":let i=parseInt(l);return isNaN(i)?v:i;case"float":return i=parseFloat(l),isNaN(i)?v:i;case"bool":return l==="true"||l==="True"?!0:l==="false"||l==="False"?!1:v;default:return l}}}}),fe=({task:t,onClick:r,kwargs:a,setKwargs:n})=>{const s=[];let o={};try{o=JSON.parse(a)}catch{}const[u,p]=f.useState(o),m=(i,c)=>{p(d=>{if(c==="")return delete d[i.name],{...d};let h=i.parse(c);return h===v?{...d}:{...d,[i.name]:h}})};return f.useEffect(()=>{n(JSON.stringify(u))},[u]),he(t.signature).forEach((i,c)=>{s.push(e.jsxs(j,{children:[e.jsx(D.Text,{children:`${i.name} (${i.type})`}),e.jsx(S,{label:`${i.name} (${i.type})`,placeholder:i.defaultValue,onChange:d=>m(i,d.target.value)},c)]}))}),e.jsxs(j,{direction:"vertical",style:{width:"390px"},children:[e.jsxs("div",{children:["Task signature: ",t.signature]}),s,e.jsx(S,{label:"Result keyword args",value:a,onChange:i=>n(i.target.value)}),e.jsx(y,{onClick:r,type:"primary",children:"Run"})]})},T={JSON:"json",INPUT:"input"},me=({task:t,onClick:r,args:a,kwargs:n,setArgs:s,setKwargs:o})=>{const[u,p]=f.useState(T.JSON);return e.jsx(Q,{defaultActiveKey:T.JSON,activeKey:u,onChange:m=>p(m),items:[{key:T.JSON,label:"JSON",children:e.jsx(pe,{task:t,onClick:r,setArgs:s,setKwargs:o})},{key:T.INPUT,label:"INPUT (experimental)",children:e.jsx(fe,{task:t,onClick:r,kwargs:n,setKwargs:o})}]})},ge=({task:t})=>{const[r,a]=f.useState(!1),[n,s]=f.useState(""),[o,u]=f.useState(""),p=b(),{mutate:m,isPending:l}=O({mutationFn:c=>R("/api/tasks/run",c),onSuccess:(c,d)=>{c.error!==null?g.error(c.error):g.success(`Task started: "${d.task_name}"`),p.invalidateQueries({queryKey:["tasks"]})},onError:(c,d,h)=>{console.log("error",c,d,h)}}),i=()=>{const c=ue(n);if(c===null)return;const d=de(o);d!==null&&(m({task_name:t.name,task_args:c?JSON.stringify(c):null,task_kwargs:d?JSON.stringify(d):null}),a(!1))};return e.jsx(C,{content:e.jsx(me,{task:t,onClick:i,args:n,kwargs:o,setArgs:s,setKwargs:u}),placement:"bottomLeft",title:"Enter args",trigger:"click",open:r,onOpenChange:c=>{a(c)},children:e.jsx(y,{loading:l,type:"primary",children:"Run"})})},xe=({onClick:t,setReason:r})=>e.jsxs(j,{direction:"vertical",style:{width:"390px"},children:[e.jsx(S,{label:"Reason",placeholder:"(example) Bug in task",onChange:a=>r(a.target.value)}),e.jsx(y,{onClick:t,danger:!0,type:"primary",children:"Drop"})]}),je=({taskName:t})=>{const[r,a]=f.useState(!1),[n,s]=f.useState(""),o=b(),{mutate:u,isPending:p}=O({mutationFn:l=>R("/api/tasks/droplist/add",l),onSuccess:(l,i)=>{l.error!==null?g.error(l.error):g.success(`Task added to drop list: "${i.task_name}"`),o.invalidateQueries({queryKey:["tasks"]})},onError:(l,i,c)=>{console.log("error",l,i,c)}}),m=()=>{if(n===null||n===""){g.error("Reason is required");return}u({task_name:t,reason:n}),a(!1)};return e.jsx(M,{title:"Adds task to droplist. Task can be run again only when removed from droplist manually",children:e.jsx(C,{content:e.jsx(xe,{onClick:m,setReason:s}),placement:"bottomLeft",title:"Drop task reason",trigger:"click",open:r,onOpenChange:l=>{a(l)},children:e.jsx(y,{type:"primary",danger:!0,loading:p,children:"Drop"})})})},ye=({taskName:t})=>{const r=b(),{mutate:a,isPending:n}=O({mutationFn:s=>R("/api/tasks/droplist/remove",s),onSuccess:(s,o)=>{s.error!==null?g.error(s.error):g.success(`Task can be run again: "${o.task_name}"`),r.invalidateQueries({queryKey:["tasks"]})},onError:(s,o,u)=>{console.log("error",s,o,u)}});return e.jsx(y,{type:"primary",danger:!0,loading:n,onClick:()=>a({task_name:t}),children:"Remove from droplist"})},x={RUNNING:"running",DROPPED:"dropped"},$={[x.RUNNING]:"green",[x.DROPPED]:"red"},Se=()=>e.jsx("div",{children:[{status:null,description:"Task is ready to be executed"},{status:x.RUNNING,description:"Task is currently executing"},{status:x.DROPPED,description:"Task has been added to droplist and no more instances can be scheduled"}].map(t=>e.jsxs("p",{children:[e.jsx(L,{color:$[t.status],children:t.status}),t.description]},t.status))}),Ne=t=>t.slice(1,t.length-1).split(",").map(r=>r.trim()).join(`
`),Te=t=>t.trim().split(`
`).map(r=>r.trim()).join(`
`),ve=({task:t})=>e.jsxs(j,{direction:"vertical",children:[e.jsxs("div",{children:["Status: ",t.status||"N/A"]}),e.jsxs("div",{children:["Signature: ",e.jsx("pre",{children:Ne(t.signature)})]}),e.jsxs("div",{children:["Doc: ",e.jsx("pre",{children:Te(t.docstring)})]}),t.status===x.DROPPED&&e.jsxs("div",{children:["Dropped reason: ",t.dropped_reason||"Not specified"]}),e.jsx("div",{children:e.jsx(q,{taskName:t.name})})]}),Pe="${taskName}",q=({taskName:t})=>{var n;const a=(n=F().logs_url)==null?void 0:n.replaceAll(Pe,t);return e.jsx("a",{target:"_blank",rel:"noreferrer",href:a,children:e.jsxs(j,{children:[e.jsx(Z,{})," Logs"]})})},ke=({tasks:t,loading:r,refetch:a})=>e.jsxs(N,{bordered:!0,loading:r,dataSource:t.map(n=>({key:n.name,...n})),expandable:{expandedRowRender:n=>e.jsx(ve,{task:n}),columnTitle:()=>e.jsx(y,{type:"primary",shape:"circle",icon:e.jsx(Y,{}),size:"small",loading:r,onClick:()=>a()})},children:[e.jsx(N.Column,{title:"Name",dataIndex:"name"}),e.jsx(N.Column,{title:e.jsxs(j,{align:"center",children:["Status",e.jsx(C,{placement:"leftTop",title:"Statuses description:",content:e.jsx(Se,{}),children:e.jsx(X,{})})]}),dataIndex:"status",render:n=>e.jsxs(L,{color:$[n],children:[n," ",n===x.STOPPING?"...":""]})}),e.jsx(N.Column,{title:"Logs",dataIndex:"name",render:n=>e.jsx(q,{taskName:n})}),e.jsx(N.Column,{title:"Action",render:n=>e.jsx(j,{children:(()=>{let s=[];return n.status===x.RUNNING?s.push(e.jsx(je,{taskName:n.name},"drop")):n.status===x.DROPPED?s.push(e.jsx(ye,{taskName:n.name},"removeTaskFromDroplist")):n.status===null&&s.push(e.jsx(ge,{task:n},"run")),s})()})})]}),be=(t,r)=>r?t.filter(a=>a.name.includes(r||"")):t,Oe=()=>{const[t,r]=V(),a=t.get("search"),[n,s]=f.useState(a),{isPending:o,isError:u,data:p,error:m,refetch:l}=H({queryKey:["tasks"],queryFn:()=>ce("/api/tasks")}),i=o;u&&console.error("Error while fetching tasks",m);const c=be((p==null?void 0:p.tasks)||[],n),d=c.filter(h=>h.status===x.RUNNING).length;return e.jsxs(e.Fragment,{children:[e.jsx(W,{children:e.jsxs(j,{direction:"vertical",children:[e.jsx(z,{loading:i,title:"Tasks running",value:d,valueStyle:{color:"#3f8600"}}),e.jsx(S.Search,{placeholder:"Enter task name ...",allowClear:!0,onChange:h=>{s(h.target.value)},onSearch:(h,De,U)=>{r(P=>(U.source==="clear"?P.delete("search"):P.set("search",h),P)),s(h)},defaultValue:a,style:{width:"500px"}})]})}),e.jsx(ke,{data:p,tasks:c,loading:i,refetch:l})]})},Ce=()=>e.jsx(ee,{children:e.jsx(I,{path:"/",children:e.jsx(I,{index:!0,element:e.jsx(Oe,{})})})}),{Header:Re,Content:Ae,Sider:Ie}=k,w="darq_ui:sidebar",_e=()=>{const[t,r]=f.useState(window.localStorage.getItem(w)==="true"),a=n=>{r(n),window.localStorage.setItem(w,n)};return e.jsxs(k,{style:{minHeight:"100vh"},children:[e.jsx(Re,{style:{padding:"0 24px"},children:e.jsx(D.Title,{style:{color:"#fff",fontSize:"24px",fontFamily:"helvetica"},children:"Darq UI"})}),e.jsxs(k,{children:[e.jsx(Ie,{collapsible:!0,collapsed:t,width:250,onCollapse:a,children:e.jsx(oe,{})}),e.jsx(Ae,{style:{padding:24},children:e.jsx(Ce,{})})]})]})},Ee=new te({defaultOptions:{queries:{refetchOnWindowFocus:!1}}});function we(){return e.jsx(re,{children:e.jsx(se,{client:Ee,children:e.jsx(_e,{})})})}ne(document.getElementById("root")).render(e.jsx(f.StrictMode,{children:e.jsx(we,{})}));
