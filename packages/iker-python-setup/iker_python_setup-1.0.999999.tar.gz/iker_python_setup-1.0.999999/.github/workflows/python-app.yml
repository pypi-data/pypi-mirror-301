name: Python App CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  LOCAL_PYPI: ${{ github.workspace }}/pypi

jobs:
  build-python311:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Setup build environment
        run: |
          sudo apt-get install libxml2-dev libxslt1-dev llvm-14-dev
          mkdir -p ${{ env.LOCAL_PYPI }}
          python -m pip install --upgrade pip build
          python -m pip config set global.find-links ${{ env.LOCAL_PYPI }}
      - name: Checkout project
        uses: actions/checkout@v4
        with:
          path: project
      - name: Build project
        run: |
          python -m pip install project/[test]
          python -m pytest project/ --cov --cov-config=project/pyproject.toml
          python -m build -sw project/ -o ${{ env.LOCAL_PYPI }}
  build-python312:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Setup build environment
        run: |
          sudo apt-get install libxml2-dev libxslt1-dev llvm-14-dev
          mkdir -p ${{ env.LOCAL_PYPI }}
          python -m pip install --upgrade pip build
          python -m pip config set global.find-links ${{ env.LOCAL_PYPI }}
      - name: Checkout project
        uses: actions/checkout@v4
        with:
          path: project
      - name: Build project
        run: |
          python -m pip install project/[test]
          python -m pytest project/ --cov --cov-config=project/pyproject.toml
          python -m build -sw project/ -o ${{ env.LOCAL_PYPI }}
